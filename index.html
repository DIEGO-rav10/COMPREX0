<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lista de Compras v4.11.4 - Orçamento Total</title> <!-- Versão incrementada -->
    <meta name="theme-color" content="#4CAF50"/>
    <link rel="apple-touch-icon" href="icon-192x192.png">
    <!-- <link rel="manifest" href="manifest.json"> -->

    <style>
        /* Reset e Globais */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; line-height: 1.6; padding: 15px; background-color: #f8f9fa; color: #343a40; }

        /* --- App Header Styling --- */
        #app-header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 25px;
            color: #2c3e50; /* Default title color */
        }
        #app-header .header-icon {
            width: 2em;
            height: 2em;
            flex-shrink: 0;
            fill: currentColor; /* Inherit color from #app-header */
        }
        #lista-titulo {
            font-size: 1.8em;
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 4px;
            border: 1px solid transparent;
            cursor: pointer;
            transition: background-color 0.2s, border-color 0.2s;
            outline: none;
        }
        #lista-titulo:hover,
        #lista-titulo:focus {
            background-color: rgba(0, 0, 0, 0.05);
            border-color: #ced4da;
        }
        #lista-titulo[contenteditable="true"] {
            cursor: text;
            box-shadow: inset 0 1px 2px rgba(0,0,0,.1);
        }


        /* --- Main Controls Container --- */
        #controles-principais {
            background-color: #ffffff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .control-group label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            color: #495057;
        }
        .input-icon {
            width: 18px;
            height: 18px;
            fill: #6c757d;
            flex-shrink: 0;
        }
        #controles-principais input[type="date"],
        #controles-principais input[type="text"],
        #controles-principais select {
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            width: 100%;
            font-size: 1em;
        }
        #controles-principais button {
             padding: 10px 15px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 1em; transition: background-color 0.2s ease; display: inline-flex; align-items: center; gap: 5px; white-space: nowrap;
             width: 100%; /* Full width on mobile */
        }
         #controles-principais button:hover { background-color: #0056b3; }
        .form-novo-produto-inner {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .form-novo-produto-inner > div {
             flex-grow: 1;
        }


        /* --- Filter Controls Container --- */
        #controles-filtros-globais {
             margin-bottom: 20px;
             padding: 15px;
             background-color: #ffffff;
             border-radius: 8px;
             box-shadow: 0 1px 3px rgba(0,0,0,0.1);
             display: flex;
             flex-wrap: wrap;
             gap: 10px;
        }
         /* Style for GLOBAL filter buttons */
         #controles-filtros-globais button {
             margin-right: 5px; margin-bottom: 5px; font-size: 0.9em;
             padding: 6px 10px; /* Adjust padding for icon */
             color: white; border:none; border-radius: 4px; cursor: pointer;
             transition: background-color 0.2s ease, filter 0.2s ease;
             display: inline-flex; /* Align icon */
             align-items: center;
             justify-content: center;
             min-width: 40px; /* Ensure button has some width */
         }
         #controles-filtros-globais button svg {
             width: 1.2em; /* Adjust icon size */
             height: 1.2em;
             fill: currentColor;
         }
         #controles-filtros-globais button:hover { filter: brightness(90%); }
         #btn-toggle-unselected { background-color: #28a745; }
         #btn-toggle-already-have { background-color: #17a2b8; }
         #btn-recolher-abas { background-color: #ffc107; color: #212529; }
         #btn-zerar-listas { background-color: #dc3545; }
         #btn-zerar-listas svg { width: 1em; height: 1em;} /* Specific size for this icon */


        /* --- Category Header (h2) Styling --- */
        h2.toggle-categoria { margin: 0; padding: 10px 15px; display: flex; flex-wrap: wrap; align-items: center; justify-content: space-between; cursor: pointer; transition: filter 0.2s ease; font-size: 1.1em; color: white; border-radius: 8px 8px 0 0; }
        h2.toggle-categoria:hover { filter: brightness(90%); }
        h2 .drag-handle { cursor: grab; margin-right: 8px; opacity: 0.7; font-size: 1.1em; line-height: 1; flex-shrink: 0; user-select: none; -webkit-user-select: none; }
        h2 .drag-handle:active { cursor: grabbing; }
        h2 .titulo-categoria { display: flex; align-items: center; gap: 8px; flex-grow: 1; order: 1; min-width: 150px; }
        h2 .nome-categoria-display { cursor: pointer; padding: 2px 4px; border: 1px solid transparent; border-radius: 3px; display: inline-block; }
        h2 .nome-categoria-display[contenteditable="true"] { cursor: text; outline: none; background-color: rgba(255, 255, 255, 0.9); color: #333; border: 1px solid #ced4da; box-shadow: inset 0 1px 2px rgba(0,0,0,.075); }
        .cabecalho-acoes { display: flex; align-items: center; gap: 6px; margin-left: 10px; order: 2; flex-shrink: 0; flex-wrap: wrap; }

        /* Default style for header action buttons */
        .cabecalho-acoes button {
            background: none; border: none; color: rgba(255, 255, 255, 0.85); font-size: 1.1em; padding: 2px 4px; line-height: 1; cursor: pointer; transition: color 0.2s ease, transform 0.2s ease; display: inline-flex; align-items: center; justify-content: center; border-radius: 3px;
        }
        .cabecalho-acoes button svg { width: 1em; height: 1em; vertical-align: middle; fill: currentColor;}

        /* Specific styles for CATEGORY filter buttons */
         .btn-toggle-cat-unselected, .btn-toggle-cat-already {
             font-size: 1em; /* Match other icons */
             padding: 3px; /* Minimal padding */
             border: none; /* Remove border */
             background-color: transparent; /* No background */
             color: rgba(255, 255, 255, 0.85); /* Default icon color */
         }
         .btn-toggle-cat-unselected:hover, .btn-toggle-cat-already:hover {
             background-color: rgba(255, 255, 255, 0.15); /* Subtle hover */
             color: #fff;
             transform: scale(1.1); /* Keep scale effect */
         }
         .btn-toggle-cat-unselected svg, .btn-toggle-cat-already svg {
            width: 1.1em; /* Slightly larger icon */
            height: 1.1em;
         }

        .btn-toggle-check-categoria:hover, .btn-edit-categoria:hover, .btn-color-categoria:hover { color: #ffffff; transform: scale(1.1); }
        .btn-delete-categoria:hover, .btn-delete-all-items-categoria:hover { color: #ffdddd; transform: scale(1.1); }


        .cabecalho-info { display: flex; align-items: center; gap: 10px; font-size: 0.8em; font-weight: normal; margin-left: 10px; padding-left: 10px; border-left: 1px solid rgba(255, 255, 255, 0.5); text-align: right; white-space: nowrap; color: white; order: 3; flex-grow: 1; justify-content: flex-end; }
         .cabecalho-info span, .cabecalho-info div { background-color: transparent; padding: 2px 4px; border-radius: 4px; border: 1px solid rgba(255, 255, 255, 0.3); display: inline-flex; align-items: center; gap: 4px; }
         .cabecalho-info .label { font-weight: normal; opacity: 0.85; }
         .cabecalho-info .valor { font-weight: bold; }
         .cabecalho-info .budget-input-wrapper { border: none; padding: 0;}
         .cabecalho-info .input-budget-categoria { width: 70px; font-size: 0.95em; padding: 2px 5px; border-radius: 3px; border: 1px solid rgba(255, 255, 255, 0.5); background-color: rgba(255, 255, 255, 0.1); color: white; text-align: right; -moz-appearance: textfield; margin-left: 3px; }
         .cabecalho-info .input-budget-categoria::placeholder { color: rgba(255, 255, 255, 0.7); font-weight: normal; }
         .cabecalho-info .input-budget-categoria::-webkit-outer-spin-button, .cabecalho-info .input-budget-categoria::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
         .cabecalho-info .budget-warning { display: none; color: #ffdddd; font-weight: bold; border-color: #dc3545; background-color: rgba(220, 53, 69, 0.2); margin-left: 5px; padding: 2px 5px; }
        .toggle-indicator { font-size: 1.2em; font-weight: bold; transition: transform 0.3s ease; margin-left: 10px; color: white; order: 4; flex-shrink: 0; }
        .categoria.expanded .toggle-indicator { transform: rotate(180deg); }

        /* General Action / Final Controls */
        .controles-acoes-gerais, .controles-finais { margin-bottom: 20px; padding: 15px; background-color: #ffffff; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); display: flex; justify-content: space-between; gap: 10px; flex-wrap: wrap; }
        .controles-acoes-gerais button, .controles-finais button { padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; font-size: 1em; transition: background-color 0.2s ease; display: inline-flex; align-items: center; gap: 5px; white-space: nowrap; }
        .controles-finais button:hover { filter: brightness(90%); } /* Generic hover */
        .controles-finais button.btn-delete { background-color: #dc3545; color: white;}
        #btn-criar-categoria { background-color: #17a2b8; color: white; }
        #btn-salvar-historico { background-color: #5a6268; color: white; }
        #btn-exportar-lista { background-color: #fd7e14; color: white; }
        #btn-copiar-lista { background-color: #6f42c1; color: white; }
        #btn-importar-lista { background-color: #0d6efd; color: white; }
        #btn-carregar-arquivo { background-color: #007bff; color: white;}
        #btn-carregar-arquivo:disabled { background-color: #6c757d; cursor: not-allowed;}
        .controles-finais select { padding: 10px; border: 1px solid #ced4da; border-radius: 4px; font-size: 1em; }
        .controles-finais label { font-weight: 600; margin-right: 8px; display: block; margin-bottom: 5px; }
        /* Hide the actual file input */
        #import-file-input { display: none; }


        /* Categorias */
        .categoria { background-color: #ffffff; margin-bottom: 15px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border: 1px solid #dee2e6; overflow: hidden; transition: transform 0.2s ease-out, box-shadow 0.2s ease-out; }
        .categoria[data-category-id="feira-semanal"] h2 { background-color: #27ae60; }
        .categoria[data-category-id="feira-mensal"] h2 { background-color: #2980b9; }
        .categoria[data-category-id="limpeza"] h2 { background-color: #e67e22; }
        .categoria[data-category-id="higiene"] h2 { background-color: #8e44ad; }
        .categoria[data-category-id="condimentos"] h2 { background-color: #f39c12; }
        .categoria[data-category-id="outros"] h2 { background-color: #7f8c8d; }
        .categoria[data-category-id^="nova-"] h2 { background-color: #1abc9c; }
        .categoria-conteudo { max-height: 0; overflow: hidden; transition: max-height 0.4s ease-out, padding 0.4s ease-out; padding: 0 15px; }
        .categoria.expanded .categoria-conteudo { max-height: 3000px; padding: 10px 15px 15px 15px; }
        .ordenacao-controles-categoria { padding-left: 0; margin-bottom: 15px; display: flex; gap: 8px; flex-wrap: wrap; }
        .ordenacao-controles-categoria button { font-size: 0.8em; padding: 4px 8px; background-color: #f8f9fa; color: #495057; border: 1px solid #dee2e6; }
        .ordenacao-controles-categoria button:hover { background-color: #e9ecef; border-color: #ced4da; }
        .ordenacao-controles-categoria button.active-sort { background-color: #007bff; color: white; border-color: #0056b3; }

        /* Itens */
        .lista-itens { padding-left: 5px; }
        .item-lista { display: flex; flex-direction: column; padding: 10px 0; border-bottom: 1px solid #e9ecef; transition: opacity 0.3s ease, max-height 0.3s ease, background-color 0.3s ease; overflow: hidden; }
        .lista-itens .item-lista:last-child { border-bottom: none; }
        .item-lista.hidden, .item-lista.item-hidden-by-filter { opacity: 0; max-height: 0; padding-top: 0; padding-bottom: 0; border-bottom: none; margin-bottom: -1px; overflow: hidden; }
        .item-linha-1 { display: flex; justify-content: space-between; align-items: center; width: 100%; margin-bottom: 8px; }
        .item-principal { display: flex; align-items: center; flex-grow: 1; }
        .item-already-have-check { margin-right: 8px; cursor: pointer; width: 18px; height: 18px; flex-shrink: 0; accent-color: #6c757d; }
        .item-check { margin-right: 10px; cursor: pointer; width: 20px; height: 20px; flex-shrink: 0; accent-color: #007bff; }
        .item-nome { cursor: pointer; flex-grow: 1; font-weight: 500; transition: color 0.3s ease, font-style 0.3s ease; word-break: break-word; padding: 2px 4px; border: 1px solid transparent; border-radius: 3px; margin-right: 5px; /* Space before dropdown */ }
        .item-nome[contenteditable="true"] { cursor: text; outline: none; background-color: #fff; border: 1px solid #ced4da; box-shadow: inset 0 1px 2px rgba(0,0,0,.075); }
        .item-check:checked + .item-nome { color: #adb5bd; }
        .item-lista.item-already-have { background-color: #f8f9fa; }
        .item-lista.item-already-have .item-nome { font-style: italic; color: #6c757d; }
        /* NEW: Item Category Dropdown */
        .item-move-cat { margin-left: auto; margin-right: 5px; flex-shrink: 0; }
        .item-categoria-select {
            font-size: 0.8em; padding: 2px 4px; border-radius: 3px; border: 1px solid #ced4da; background-color: #f8f9fa; max-width: 120px; cursor: pointer;
        }
        .item-categoria-select:hover { border-color: #adb5bd; }

        .btn-remover-item { background: none; border: none; color: #dc3545; font-size: 1.3em; cursor: pointer; padding: 0 5px; margin-left: 0px; line-height: 1; flex-shrink: 0; }
        .btn-remover-item:hover { color: #a02532; }
        .item-detalhes { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; padding-left: 46px; width: 100%; }
        .item-detalhes label { font-size: 0.85em; color: #6c757d; margin-right: 5px; }
        .qtd-stepper { display: flex; align-items: center; } .qtd-stepper button { font-size: 1.1em; padding: 0 6px; line-height: 1; min-width: 28px; height: 28px; background-color: #e9ecef; border: 1px solid #ced4da; color: #495057; } .qtd-stepper button:hover { background-color: #dee2e6; } .qtd-stepper .btn-qtd-down { border-top-right-radius: 0; border-bottom-right-radius: 0; } .qtd-stepper .btn-qtd-up { border-top-left-radius: 0; border-bottom-left-radius: 0; } .qtd-stepper input.input-qtd { width: 55px; text-align: center; border-radius: 0; border-left: none; border-right: none; font-size: 0.95em; padding: 5px 2px; height: 28px; -moz-appearance: textfield; } .qtd-stepper input.input-qtd::-webkit-outer-spin-button, .qtd-stepper input.input-qtd::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .item-detalhes input.input-preco { padding: 6px 8px; border: 1px solid #ced4da; border-radius: 4px; width: 75px; text-align: right; font-size: 0.95em; -moz-appearance: textfield; height: 28px; }
        .item-detalhes input.input-preco::placeholder { color: #adb5bd; font-style: italic; }
        .item-detalhes input.input-preco::-webkit-outer-spin-button, .item-detalhes input.input-preco::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .item-total { font-weight: 600; color: #212529; margin-left: auto; font-size: 0.95em; white-space: nowrap; align-self: center; }

        /* Totais */
        .categoria-total { text-align: right; margin-top: 15px; padding-top: 10px; border-top: 1px dashed #ced4da; font-weight: bold; font-size: 1.1em; color: #0056b3; }
        #total-geral {
             margin-top: 25px; padding: 15px; background-color: #2c3e50; color: white; text-align: center; font-size: 1.3em; font-weight: bold; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
             display: flex; justify-content: center; align-items: center; gap: 20px; flex-wrap: wrap;
             transition: background-color 0.3s ease; /* Added for smooth transition */
        }
        #total-geral > span { white-space: nowrap; }
        #contador-produtos-selecionados { font-weight: bold; color: #ffc107; }

        /* NEW: Total Budget Styles */
        .orcamento-total-wrapper {
            display: flex;
            align-items: center;
            gap: 8px;
            border-right: 1px solid rgba(255, 255, 255, 0.4); /* Separator */
            padding-right: 20px;
            margin-right: 0; /* Adjust gap handled by main div */
        }
        .orcamento-total-wrapper label {
            font-size: 0.9em; /* Slightly smaller */
            font-weight: normal; /* Less emphasis than total */
            opacity: 0.9;
        }
        #input-orcamento-total {
            width: 120px; /* Adjust width as needed */
            padding: 5px 8px;
            font-size: 1em; /* Match total font size */
            font-weight: bold;
            text-align: right;
            border-radius: 4px;
            border: 1px solid rgba(255, 255, 255, 0.5);
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
            -moz-appearance: textfield;
        }
        #input-orcamento-total::placeholder {
            color: rgba(255, 255, 255, 0.7);
            font-weight: normal;
        }
        #input-orcamento-total::-webkit-outer-spin-button,
        #input-orcamento-total::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        /* NEW: Warning State */
        #total-geral.orcamento-excedido {
            background-color: #c0392b; /* Red warning background */
            border: 2px solid #ffdddd;
        }
        #total-geral.orcamento-excedido #valor-total-geral {
             color: #ffc107; /* Highlight total value */
             font-weight: bolder;
        }


        #categorias-container + .controles-acoes-gerais { margin-top: 10px; }
        .controles-finais { margin-top: -10px; } /* Overlap slightly with shadow */

        /* Drag and Drop */
        .categoria.dragging { visibility: hidden; border: 2px dashed #007bff !important; box-shadow: none; }
        .drag-over { border-top: 3px solid #0056b3 !important; }

        /* Color Picker */
        #color-picker-popup { position: absolute; background-color: white; border: 1px solid #ccc; border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); padding: 10px; display: none; z-index: 100; flex-wrap: wrap; gap: 8px; width: 150px; }
        .color-swatch { width: 25px; height: 25px; border-radius: 4px; border: 1px solid #eee; cursor: pointer; transition: transform 0.1s ease; }
        .color-swatch:hover { transform: scale(1.1); border-color: #999; }

        /* Responsividade */
        @media (min-width: 768px) { /* Desktop / Larger tablets */
            #controles-principais { flex-direction: row; align-items: flex-end; gap: 20px; }
             #controles-principais .control-group { flex-direction: column; flex-grow: 1; gap: 5px; }
            #controles-principais .control-group-date { flex-grow: 0; width: 150px; }
            #controles-principais .control-group-search { flex-grow: 2; }
            #controles-principais .control-group-add { flex-grow: 2; flex-direction: row; align-items: flex-end; gap: 10px; }
            .form-novo-produto-inner { flex-direction: row; flex-grow: 1; gap: 10px; }
             .form-novo-produto-inner > div { flex-grow: 1; min-width: 150px; }
             #controles-principais button { width: auto; flex-shrink: 0; }
             #controles-filtros-globais { justify-content: flex-start; }

             .item-lista { flex-direction: row; align-items: center; }
             .item-linha-1 { margin-bottom: 0; flex-grow: 1; }
             .item-principal { flex-grow: 1; }
             .item-detalhes { padding-left: 15px; width: auto; flex-wrap: nowrap; flex-shrink: 0; }
             .item-total { min-width: 80px; }
             h2.toggle-categoria { flex-wrap: nowrap; }
             .cabecalho-info { justify-content: flex-end; margin-left: 15px; order: 3; }
             .cabecalho-acoes { order: 2; flex-wrap: nowrap; /* Prevent wrapping actions on desktop */ }
             .titulo-categoria { order: 1; }
             .toggle-indicator { order: 4; }

             .controles-acoes-gerais, .controles-finais { flex-wrap: nowrap; }
             .controles-finais > div { flex-direction: row; align-items: flex-end; gap: 10px; justify-content: center; width: auto; }
             .controles-finais > div > div { max-width: 300px; width: auto; }
             .controles-finais select { min-width: 200px; }
             .controles-finais label { text-align: left; margin-bottom: 0;}
             .item-move-cat { margin-left: 10px; }
             .item-categoria-select { max-width: 150px; }
         }
         @media (max-width: 767px) { /* Mobile / Smaller tablets */
             h2.toggle-categoria { flex-wrap: wrap; padding-bottom: 8px; gap: 5px 10px; }
            .titulo-categoria { order: 1; width: calc(100% - 40px); margin-bottom: 5px; min-width: 0;}
            .cabecalho-acoes { order: 2; margin-left: 0; margin-right: auto;} /* Actions wrap below title */
            .toggle-indicator { order: 3; margin-left: auto; }
            .cabecalho-info { order: 4; width: 100%; margin-left: 0; padding-left: 0; margin-top: 8px; justify-content: space-between; border-left: none; padding-top: 8px; border-top: 1px solid rgba(255, 255, 255, 0.4); flex-wrap: wrap; gap: 8px;}
            .cabecalho-info span, .cabecalho-info div { font-size: 0.85em; }
            .cabecalho-info .budget-input-wrapper { flex-basis: 100%; justify-content: flex-end;}

            #controles-principais input[type="date"], #controles-principais input[type="text"], #controles-principais select { width: 100%; margin-bottom: 0; }
            .form-novo-produto-inner { width: 100%; } .form-novo-produto-inner > div { width: 100%; }
            #controles-filtros-globais { flex-direction: column; align-items: stretch; } #controles-filtros-globais button { width: 100%; margin-right: 0; margin-bottom: 10px;}
            .controles-acoes-gerais, .controles-finais { flex-direction: column; align-items: stretch;} .controles-acoes-gerais button, .controles-finais button { width: 100%; margin-bottom: 10px; margin-right: 0;}
            .controles-finais > div { flex-direction: column; align-items: stretch !important; width: 100%; gap: 5px; }
            .controles-finais > div > div { max-width: none; width: 100%; }
            .controles-finais select { width: 100%; } .controles-finais label { text-align: left !important;}
            .ordenacao-controles-categoria { padding-left: 0; justify-content: center; } .item-detalhes { padding-left: 30px; }
            .item-move-cat { margin-left: 5px; }

            /* NEW: Responsive Total Budget */
             #total-geral {
                 flex-direction: column; /* Stack elements on mobile */
                 gap: 10px;
                 align-items: stretch; /* Stretch budget input */
                 text-align: center;
             }
             .orcamento-total-wrapper {
                 border-right: none;
                 padding-right: 0;
                 justify-content: center; /* Center budget elements */
                 border-bottom: 1px solid rgba(255, 255, 255, 0.4); /* Separator */
                 padding-bottom: 10px;
                 margin-bottom: 5px;
             }
             #input-orcamento-total {
                 width: 150px; /* Or adjust as preferred */
             }
             #total-geral > span:not(.orcamento-total-wrapper) {
                 text-align: center;
                 width: 100%;
             }
        }
    </style>
</head>
<body>

    <header id="app-header">
        <!-- Shopping Cart Icon -->
        <svg class="header-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16">
          <path d="M0 1.5A.5.5 0 0 1 .5 1H2a.5.5 0 0 1 .485.379L2.89 3H14.5a.5.5 0 0 1 .491.592l-1.5 8A.5.5 0 0 1 13 12H4a.5.5 0 0 1-.491-.408L2.01 3.607 1.61 2H.5a.5.5 0 0 1-.5-.5M3.102 4l1.313 7h8.17l1.313-7zM5 12.5a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-1 0v-1a.5.5 0 0 1 .5-.5m8 0a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-1 0v-1a.5.5 0 0 1 .5-.5m-6.5 1a.5.5 0 0 0 0-1h1a.5.5 0 0 0 0 1z"/>
        </svg>
        <!-- Editable Title -->
        <span id="lista-titulo" contenteditable="true" title="Clique para editar o nome da lista">Lista de Compras Avançada</span>
    </header>

    <!-- Controles Principais -->
    <div id="controles-principais">
        <div class="control-group control-group-date">
            <label for="data-compra">
                <svg class="input-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M4 .5a.5.5 0 0 0-1 0V1H2a2 2 0 0 0-2 2v1h16V3a2 2 0 0 0-2-2h-1V.5a.5.5 0 0 0-1 0V1H4zM16 14V5H0v9a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2M8 7.993c0-.552.447-1 1-1h2c.553 0 1 .448 1 1s-.447 1-1 1h-2c-.553 0-1-.448-1-1m-4 0c0-.552.447-1 1-1h2c.553 0 1 .448 1 1s-.447 1-1 1h-2c-.553 0-1-.448-1-1m4 3c0-.552.447-1 1-1h2c.553 0 1 .448 1 1s-.447 1-1 1h-2c-.553 0-1-.448-1-1m-4 0c0-.552.447-1 1-1h2c.553 0 1 .448 1 1s-.447 1-1 1h-2c-.553 0-1-.448-1-1"/></svg>
                Data da Compra:
            </label>
            <input type="date" id="data-compra" name="data-compra">
        </div>

        <div class="control-group control-group-search">
            <label for="filtro-nome">
                 <svg class="input-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001q.044.06.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1 1 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0"/></svg>
                Buscar Item:
            </label>
            <input type="text" id="filtro-nome" placeholder="Digite o nome do item...">
        </div>

        <div class="control-group control-group-add">
            <div class="form-novo-produto-inner">
                 <div>
                     <label for="novo-produto-nome">
                         <svg class="input-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M8.5 6.034V4.5a.5.5 0 0 0-1 0V6.034a.5.5 0 0 0 .002.048l.003.03a.5.5 0 0 0 .01.044l.014.048a.514.514 0 0 0 .02.046l.029.055a.5.5 0 0 0 .035.053l.041.053a.5.5 0 0 0 .048.048l.053.041a.5.5 0 0 0 .053.035l.055.029a.514.514 0 0 0 .046.02l.048.014a.5.5 0 0 0 .044.01l.03.003a.5.5 0 0 0 .048.002H8.5zm-.004 1.03.003.03a.5.5 0 0 0 .01.044l.014.048a.514.514 0 0 0 .02.046l.029.055a.5.5 0 0 0 .035.053l.041.053a.5.5 0 0 0 .048.048l.053.041a.5.5 0 0 0 .053.035l.055.029a.514.514 0 0 0 .046.02l.048.014a.5.5 0 0 0 .044.01l.03.003a.5.5 0 0 0 .048.002h.002a.5.5 0 0 0 .048-.002l.03-.003a.5.5 0 0 0 .044-.01l.048-.014a.514.514 0 0 0 .046-.02l.055-.029a.5.5 0 0 0 .053-.035l.053-.041a.5.5 0 0 0 .048-.048l.041-.053a.5.5 0 0 0 .035-.053l.029-.055a.514.514 0 0 0 .02-.046l.014-.048a.5.5 0 0 0 .01-.044l.003-.03a.5.5 0 0 0 .002-.048V8.5a.5.5 0 0 0-1 0v.034a.5.5 0 0 0 .002.048zM16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0M8 5a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 5"/></svg>
                         Novo Item:
                    </label>
                    <input type="text" id="novo-produto-nome" placeholder="Nome do produto">
                </div>
                <div>
                    <label for="novo-produto-categoria">Categoria:</label>
                    <select id="novo-produto-categoria"></select>
                </div>
            </div>
            <button id="btn-add-produto">Adicionar</button>
        </div>
    </div>

    <!-- Filtros Globais -->
    <div id="controles-filtros-globais">
        <button id="btn-toggle-unselected" title="Mostrar/Ocultar itens não marcados para compra">
             <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-eye-slash-fill" viewBox="0 0 16 16"> <path d="m10.79 12.912-1.614-1.615a3.5 3.5 0 0 1-4.474-4.474l-2.06-2.06C.938 6.278 0 8 0 8s3 5.5 8 5.5a7.029 7.029 0 0 0 2.79-.588M5.21 3.088A7.028 7.028 0 0 1 8 2.5c5 0 8 5.5 8 5.5s-.939 1.721-2.641 3.238l-2.062-2.062a3.5 3.5 0 0 0-4.474-4.474z"/> <path d="M5.525 7.646a2.5 2.5 0 0 0 2.829 2.829l-2.83-2.829zm4.95.708-2.829-2.83a2.5 2.5 0 0 1 2.829 2.829zm3.171 6-12-12 .708-.708 12 12z"/> </svg>
        </button>
        <button id="btn-toggle-already-have" title="Mostrar/Ocultar itens marcados como 'Já Tenho'">
             <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-house-fill" viewBox="0 0 16 16"> <path d="M8.707 1.5a1 1 0 0 0-1.414 0L.646 8.146a.5.5 0 0 0 .708.708L8 2.207l6.646 6.647a.5.5 0 0 0 .708-.708L13 5.793V2.5a.5.5 0 0 0-.5-.5h-1a.5.5 0 0 0-.5.5v1.293z"/> <path d="m8 3.293 6 6V13.5a1.5 1.5 0 0 1-1.5 1.5h-9A1.5 1.5 0 0 1 2 13.5V9.293z"/> </svg>
        </button>
        <button id="btn-recolher-abas" title="Fechar todas as categorias">Recolher Abas</button>
        <button id="btn-zerar-listas" title="Excluir TODOS os itens de TODAS as categorias">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
              <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z"/>
              <path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3h11V2h-11z"/>
            </svg>
            Zerar Listas
        </button>
    </div>

    <div id="categorias-container">
        <!-- Categorias serão geradas/carregadas aqui pelo JS -->
    </div> <!-- Fim #categorias-container -->

     <!-- Popup do Seletor de Cores -->
     <div id="color-picker-popup">
         <!-- As cores serão adicionadas aqui pelo JS -->
     </div>

    <!-- Botão Criar Categoria -->
    <div class="controles-acoes-gerais">
        <button id="btn-criar-categoria" title="Adicionar uma nova seção à lista"> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"> <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16"/> <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4"/> </svg> Criar Nova Categoria </button>
     </div>

    <!-- Controles Finais -->
    <div class="controles-finais">
         <button id="btn-salvar-historico" title="Salvar estado atual como um arquivo no histórico">Salvar Lista no Histórico</button>
         <div style="flex-grow: 1; display: flex; align-items: flex-end; gap: 10px; justify-content: center;">
             <div style="flex-grow: 1; max-width: 300px;">
                  <label for="select-arquivos" style="text-align: left;">Histórico:</label>
                  <select id="select-arquivos"><option value="">Selecione...</option></select>
             </div>
              <button id="btn-carregar-arquivo" disabled title="Carregar lista selecionada">Carregar</button>
             <button id="btn-deletar-arquivo" class="btn-delete" disabled title="Deletar lista selecionada">Deletar</button>
         </div>
         <!-- Copy Button -->
         <button id="btn-copiar-lista" title="Copiar lista para área de transferência">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard" viewBox="0 0 16 16">
              <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1z"/>
              <path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0z"/>
            </svg>
            Copiar Lista
         </button>
         <button id="btn-exportar-lista" title="Baixar a lista atual como arquivo de texto">Exportar Lista Atual (.txt)</button>
         <!-- Hidden file input for import -->
         <input type="file" id="import-file-input" accept=".json,.txt" style="display: none;">
         <button id="btn-importar-lista" title="Importar itens de arquivo .json">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload" viewBox="0 0 16 16">
              <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/>
              <path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z"/>
            </svg>
            Importar Itens (.json)
        </button>
     </div>

    <div id="total-geral">
         <!-- NEW: Total Budget Input -->
         <span class="orcamento-total-wrapper">
            <label for="input-orcamento-total">ORÇAMENTO TOTAL:</label>
            <input type="number" step="0.01" placeholder="R$ 0,00" id="input-orcamento-total" inputmode="decimal" title="Defina o orçamento total da compra">
        </span>
        <!-- Existing Totals -->
        <span>Produtos: <span id="contador-produtos-selecionados">0</span></span>
        <span>Total Geral Selecionado: <span id="valor-total-geral">R$ 0,00</span></span>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- Seletores Estáticos ---
            const appHeader = document.getElementById('app-header');
            const listaTituloSpan = document.getElementById('lista-titulo');
            const controlesPrincipais = document.getElementById('controles-principais');
            const controlesFiltrosGlobais = document.getElementById('controles-filtros-globais');
            const categoriasContainer = document.getElementById('categorias-container');
            const filtroInput = document.getElementById('filtro-nome');
            const novoProdutoNomeInput = document.getElementById('novo-produto-nome');
            const novoProdutoCategoriaSelect = document.getElementById('novo-produto-categoria');
            const addProdutoBtn = document.getElementById('btn-add-produto');
            const totalGeralDisplay = document.getElementById('total-geral');
            const contadorProdutosSpan = document.getElementById('contador-produtos-selecionados');
            const valorTotalGeralSpan = document.getElementById('valor-total-geral');
            const dataCompraInput = document.getElementById('data-compra');
            const btnSalvarHistorico = document.getElementById('btn-salvar-historico');
            const selectArquivos = document.getElementById('select-arquivos');
            const btnCarregarArquivo = document.getElementById('btn-carregar-arquivo');
            const btnDeletarArquivo = document.getElementById('btn-deletar-arquivo');
            const btnRecolherAbas = document.getElementById('btn-recolher-abas');
            const btnCriarCategoria = document.getElementById('btn-criar-categoria');
            const btnToggleUnselected = document.getElementById('btn-toggle-unselected');
            const btnToggleAlreadyHave = document.getElementById('btn-toggle-already-have');
            const btnZerarListas = document.getElementById('btn-zerar-listas'); // New
            const btnExportarLista = document.getElementById('btn-exportar-lista');
            const btnCopiarLista = document.getElementById('btn-copiar-lista');
            const btnImportarLista = document.getElementById('btn-importar-lista');
            const importFileInput = document.getElementById('import-file-input');
            const colorPickerPopup = document.getElementById('color-picker-popup');
            const inputOrcamentoTotal = document.getElementById('input-orcamento-total'); // NEW

            // --- Estado da Aplicação ---
            let dadosLista = {};
            let arquivos = {};
            let unselectedItemsVisible = true;
            let alreadyHaveItemsVisible = true;
            let draggedCategory = null;
            let categoriasDefinidas = [];
            let listaTitulo = 'Lista de Compras Avançada';
            let currentEditingTitle = '';
            let currentPopupTargetType = null;
            let orcamentoTotal = null; // NEW: State for total budget

            const KEY_STORAGE_ATIVA = 'listaComprasAtiva_v4.11.4'; // Incrementa versão
            const KEY_STORAGE_ARQUIVOS = 'listaComprasArquivadas_v4.11.4'; // Incrementa versão

            // Default colors for CATEGORIES
            const DEFAULT_COLORS = [
                '#27ae60', '#2980b9', '#e67e22', '#8e44ad', '#f39c12', '#7f8c8d',
                '#1abc9c', '#c0392b', '#d35400', '#34495e', '#f1c40f', '#95a5a6',
                '#2c3e50', '#3498db', '#e74c3c', '#9b59b6'
            ];

             // --- Utilitários ---
             const formatarMoeda = (v) => isNaN(Number(v)) ? 'R$ 0,00' : Number(v).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
             const gerarIdUnico = () => Date.now().toString(36) + Math.random().toString(36).slice(-6);
             const formatarDataHoraParaChave = (ts = Date.now()) => { const d = new Date(ts); const p = (n) => n.toString().padStart(2, '0'); return `Lista_${d.getFullYear()}${p(d.getMonth() + 1)}${p(d.getDate())}_${p(d.getHours())}${p(d.getMinutes())}${p(d.getSeconds())}`; };
             const normalizarTexto = (t = '') => t.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
             const gerarIdCategoria = (n) => `nova-${normalizarTexto(n).replace(/[^a-z0-9-]/g, '').replace(/\s+/g, '-')}-${gerarIdUnico()}`;
             // NEW: Helper to parse currency string back to number
             const parseMoeda = (str) => {
                if (!str) return 0;
                try {
                    // Remove 'R$', space, thousands separator (.), replace decimal comma with dot
                    const numericString = String(str).replace(/R\$\s?/g, '').replace(/\./g, '').replace(',', '.');
                    const number = parseFloat(numericString);
                    return isNaN(number) ? 0 : number;
                } catch (e) {
                    console.error("Erro ao parsear moeda:", str, e);
                    return 0;
                }
            };

             // --- Cálculos ---
             const calcularTotalItem = (itemEl) => { const qtd = parseFloat(itemEl.querySelector('.input-qtd')?.value) || 0; const preco = parseFloat(itemEl.querySelector('.input-preco')?.value) || 0; const totalDisplay = itemEl.querySelector('.item-total'); if (totalDisplay) totalDisplay.textContent = formatarMoeda(qtd * preco); };
             const calcularInfoCategoria = (catEl) => {
                 if(!catEl) return; let totalMarcados = 0, countMarcados = 0; const catId = catEl.dataset.categoryId; const contagemSpan = catEl.querySelector(`#contagem-cat-${catId}`); const precoSpan = catEl.querySelector(`#preco-cat-${catId}`); const totalRodapeDisp = catEl.querySelector('.categoria-total'); const budgetInput = catEl.querySelector('.input-budget-categoria'); const budgetWarning = catEl.querySelector('.budget-warning');
                 catEl.querySelectorAll('.item-lista').forEach(itemEl => { if (!itemEl.classList.contains('hidden')) { calcularTotalItem(itemEl); if (!itemEl.classList.contains('item-already-have') && itemEl.querySelector('.item-check')?.checked) { countMarcados++; totalMarcados += (parseFloat(itemEl.querySelector('.input-qtd')?.value) || 0) * (parseFloat(itemEl.querySelector('.input-preco')?.value) || 0); } } else { calcularTotalItem(itemEl); } });
                 if (contagemSpan) contagemSpan.textContent = countMarcados; if (precoSpan) precoSpan.textContent = formatarMoeda(totalMarcados); if (totalRodapeDisp) totalRodapeDisp.textContent = `Total Selecionado: ${formatarMoeda(totalMarcados)}`;
                 if (budgetInput && budgetWarning) { const budgetValue = parseFloat(budgetInput.value); if (!isNaN(budgetValue) && budgetValue > 0) budgetWarning.style.display = totalMarcados > budgetValue ? 'inline-flex' : 'none'; else budgetWarning.style.display = 'none'; }
             };

             // NEW: Function to check total budget
             const verificarOrcamentoTotal = () => {
                 if (!totalGeralDisplay || !valorTotalGeralSpan) return;
                 const totalGeralAtual = parseMoeda(valorTotalGeralSpan.textContent);
                 let excedido = false;
                 if (orcamentoTotal !== null && !isNaN(orcamentoTotal) && orcamentoTotal > 0) {
                     if (totalGeralAtual > orcamentoTotal) {
                         excedido = true;
                     }
                 }
                 totalGeralDisplay.classList.toggle('orcamento-excedido', excedido);
             };

             const calcularTotalGeral = () => {
                 let totalGeralValor = 0; let contadorItens = 0;
                 Object.values(dadosLista).forEach(item => {
                     const itemEl = categoriasContainer.querySelector(`.item-lista[data-item-id="${item.id}"]`);
                     const isHiddenByFilter = itemEl && itemEl.classList.contains('item-hidden-by-filter');
                     const isHiddenBySearch = itemEl && itemEl.classList.contains('hidden'); // Consider search too
                     // Calculate total only for items that are CHECKED, NOT 'already have', and NOT HIDDEN by ANY filter
                     if (item.checked && !item.alreadyHave && !isHiddenByFilter && !isHiddenBySearch) {
                         totalGeralValor += (parseFloat(item.qtd) || 0) * (parseFloat(item.preco) || 0);
                         contadorItens++;
                     }
                 });
                 if (contadorProdutosSpan) contadorProdutosSpan.textContent = contadorItens;
                 if (valorTotalGeralSpan) valorTotalGeralSpan.textContent = formatarMoeda(totalGeralValor);

                 verificarOrcamentoTotal(); // NEW: Check budget after calculating total
             };

             // --- DOM e Eventos dos Itens ---
             const criarElementoItem = (itemData) => {
                 const li = document.createElement('li'); li.className = 'item-lista'; if (itemData.alreadyHave) li.classList.add('item-already-have'); li.dataset.itemId = itemData.id;
                 li.innerHTML = ` <div class="item-linha-1"> <div class="item-principal"> <input type="checkbox" id="alreadyhave-${itemData.id}" class="item-already-have-check" title="Marcar como 'Já Tenho'" ${itemData.alreadyHave ? 'checked' : ''}> <input type="checkbox" id="item-${itemData.id}" class="item-check" title="Marcar para Comprar" ${itemData.checked ? 'checked' : ''}> <label for="item-${itemData.id}" class="item-nome" title="Duplo clique para editar">${itemData.nome}</label> </div> <div class="item-move-cat"> <select class="item-categoria-select" title="Mover para..."></select> </div> <button class="btn-remover-item" title="Remover Item">×</button> </div> <div class="item-detalhes"> <label for="qtd-${itemData.id}">Qtd:</label> <div class="qtd-stepper"> <button type="button" class="btn-qtd-down" aria-label="Diminuir quantidade">-</button> <input type="number" step="0.1" placeholder="Qtd" class="input-qtd" id="qtd-${itemData.id}" value="${itemData.qtd || '1.0'}" inputmode="decimal"> <button type="button" class="btn-qtd-up" aria-label="Aumentar quantidade">+</button> </div> <label for="preco-${itemData.id}">Preço:</label> <input type="number" step="0.01" placeholder="0,00" class="input-preco" id="preco-${itemData.id}" value="${itemData.preco || ''}" inputmode="decimal"> <span class="item-total">R$ 0.00</span> </div>`;
                 const nomeLabel = li.querySelector('.item-nome');
                 const precoInput = li.querySelector('.input-preco');
                 const categoriaSelect = li.querySelector('.item-categoria-select');
                 li.querySelector('.item-check').addEventListener('change', handleItemPurchaseChange); li.querySelector('.item-already-have-check').addEventListener('change', handleItemAlreadyHaveChange); precoInput.addEventListener('input', handleItemDetailsChange); precoInput.addEventListener('blur', handlePriceInputBlur); li.querySelector('.input-qtd').addEventListener('input', handleItemDetailsChange); li.querySelector('.btn-remover-item').addEventListener('click', handleRemoveItem); nomeLabel.addEventListener('dblclick', handleEditNameStart); nomeLabel.addEventListener('blur', handleEditNameEnd); nomeLabel.addEventListener('keydown', handleEditNameKeydown); categoriaSelect.addEventListener('change', handleMoveItemCategory);
                 _populateSingleItemCategorySelect(categoriaSelect, itemData.categoriaId);
                 calcularTotalItem(li);
                 if(itemData.preco) handlePriceInputBlur({target: precoInput});
                 return li;
             };
             const adicionarItemNaCategoria = (itemData, categoriaId, subId = null) => { const catTarget = categoriasContainer.querySelector(`.categoria[data-category-id="${categoriaId}"]`); if (!catTarget) return; const subcatId = subId || `${categoriaId}-geral`; const conteudo = catTarget.querySelector('.categoria-conteudo'); if (!conteudo) return; let listaTarget = conteudo.querySelector(`.lista-itens[data-subcategory="${subcatId}"]`); if (!listaTarget) listaTarget = conteudo.querySelector('.lista-itens'); if (!listaTarget) return; const itemEl = criarElementoItem(itemData); listaTarget.appendChild(itemEl); if (!dadosLista[itemData.id]) dadosLista[itemData.id] = { ...itemData, categoriaId, subcategoriaId: subcatId }; aplicarFiltrosVisibilidadeItens(); updateCategoryToggleButtonState(catTarget); }; // Call calcularTotalGeral AFTER adding item
             const handleItemDetailsChange = (e) => { const itemEl = e.target.closest('.item-lista'); if (!itemEl) return; const itemId = itemEl.dataset.itemId; if (dadosLista[itemId]) { dadosLista[itemId].qtd = itemEl.querySelector('.input-qtd').value; dadosLista[itemId].preco = itemEl.querySelector('.input-preco').value; } calcularTotalItem(itemEl); const catEl = itemEl.closest('.categoria'); if (catEl) calcularInfoCategoria(catEl); calcularTotalGeral(); salvarDadosAtivos(); };
             const handleItemPurchaseChange = (e) => { const itemEl = e.target.closest('.item-lista'); if (!itemEl) return; const itemId = itemEl.dataset.itemId; if (dadosLista[itemId]) dadosLista[itemId].checked = e.target.checked; aplicarFiltrosVisibilidadeItens(); const catEl = itemEl.closest('.categoria'); if (catEl) { calcularInfoCategoria(catEl); updateCategoryToggleButtonState(catEl); } calcularTotalGeral(); salvarDadosAtivos(); };
             const handleItemAlreadyHaveChange = (e) => { const itemEl = e.target.closest('.item-lista'); if (!itemEl) return; const itemId = itemEl.dataset.itemId; const isAlreadyHave = e.target.checked; if (dadosLista[itemId]) dadosLista[itemId].alreadyHave = isAlreadyHave; itemEl.classList.toggle('item-already-have', isAlreadyHave); aplicarFiltrosVisibilidadeItens(); const catEl = itemEl.closest('.categoria'); if (catEl) calcularInfoCategoria(catEl); calcularTotalGeral(); salvarDadosAtivos(); };
             const handleEditNameStart = (e) => { e.target.contentEditable = true; e.target.focus(); e.target.dataset.originalName = e.target.textContent; };
             const handleEditNameEnd = (e) => { const label = e.target; label.contentEditable = false; const itemId = label.closest('.item-lista')?.dataset.itemId; const novoNome = label.textContent.trim(); if (novoNome && dadosLista[itemId] && novoNome !== dadosLista[itemId].nome) { dadosLista[itemId].nome = novoNome; salvarDadosAtivos(); } else { label.textContent = dadosLista[itemId]?.nome || label.dataset.originalName || 'Erro'; } delete label.dataset.originalName; };
             const handleEditNameKeydown = (e) => { if (e.key === 'Enter') { e.preventDefault(); e.target.blur(); } else if (e.key === 'Escape') { e.target.textContent = e.target.dataset.originalName || dadosLista[e.target.closest('.item-lista')?.dataset.itemId]?.nome || ''; e.target.blur(); } };
             const handleRemoveItem = (e) => { const itemEl = e.target.closest('.item-lista'); if (!itemEl) return; const itemId = itemEl.dataset.itemId; const nome = dadosLista[itemId]?.nome || 'este item'; if (confirm(`Remover "${nome}"?`)) { const catEl = itemEl.closest('.categoria'); delete dadosLista[itemId]; itemEl.remove(); if (catEl) { calcularInfoCategoria(catEl); updateCategoryToggleButtonState(catEl); } calcularTotalGeral(); salvarDadosAtivos(); } };
             const handleStepperClick = (button) => { const stepperDiv = button.closest('.qtd-stepper'); const inputQtd = stepperDiv?.querySelector('.input-qtd'); if (!inputQtd) return; const step = 0.1; const currentValue = parseFloat(inputQtd.value.replace(',', '.')) || 0; let newValue; if (button.classList.contains('btn-qtd-up')) newValue = currentValue + step; else if (button.classList.contains('btn-qtd-down')) newValue = currentValue - step; else return; newValue = Math.max(0, newValue).toFixed(1); inputQtd.value = newValue; handleItemDetailsChange({ target: inputQtd }); };

              // --- Price Input Blur Handler ---
              const handlePriceInputBlur = (e) => {
                const inputElement = e.target; let value = inputElement.value.trim();
                if (value === '') { handleItemDetailsChange({ target: inputElement }); return; } // Allow empty
                const numericString = value.replace(',', '.'); const parsedValue = parseFloat(numericString);
                if (!isNaN(parsedValue)) { const formattedValue = parsedValue.toFixed(2); inputElement.value = formattedValue; handleItemDetailsChange({ target: inputElement }); }
                else { inputElement.value = ''; handleItemDetailsChange({ target: inputElement }); } // Clear if invalid
             };

              // --- Budget Input Blur Handler ---
              const handleBudgetInputBlur = (e) => {
                const inputElement = e.target; let value = inputElement.value.trim();
                if (value === '') { handleBudgetChange(inputElement); return; } // Allow empty
                const numericString = value.replace(',', '.'); const parsedValue = parseFloat(numericString);
                if (!isNaN(parsedValue)) { const formattedValue = parsedValue.toFixed(2); inputElement.value = formattedValue; handleBudgetChange(inputElement); }
                else { inputElement.value = ''; handleBudgetChange(inputElement); } // Clear if invalid
              };

              // --- NEW: Total Budget Handlers ---
              const handleOrcamentoTotalChange = (e) => {
                  const inputElement = e.target;
                  const value = inputElement.value.trim();
                  if (value === '') {
                      orcamentoTotal = null;
                  } else {
                      const numericString = value.replace(',', '.');
                      const parsedValue = parseFloat(numericString);
                      orcamentoTotal = isNaN(parsedValue) ? null : parsedValue; // Store number or null
                  }
                  verificarOrcamentoTotal(); // Check immediately
                  salvarDadosAtivos(); // Save the change
              };

              const handleOrcamentoTotalBlur = (e) => {
                  const inputElement = e.target;
                  let value = inputElement.value.trim();
                  if (value === '') {
                      orcamentoTotal = null; // Ensure state is null if cleared
                      verificarOrcamentoTotal();
                      salvarDadosAtivos();
                      return;
                  }
                  const numericString = value.replace(',', '.');
                  const parsedValue = parseFloat(numericString);
                  if (!isNaN(parsedValue)) {
                      const formattedValue = parsedValue.toFixed(2);
                      inputElement.value = formattedValue;
                      orcamentoTotal = parsedValue; // Update state with parsed number
                  } else {
                      inputElement.value = ''; // Clear input if invalid
                      orcamentoTotal = null; // Clear state if invalid
                  }
                  verificarOrcamentoTotal();
                  salvarDadosAtivos();
              };

              // --- Categoria Edição/Exclusão/Orçamento/Check-Uncheck ---
              const handleEditCategoryStart = (button) => { const h2 = button.closest('h2'); const nameSpan = h2?.querySelector('.nome-categoria-display'); if (nameSpan) { nameSpan.contentEditable = true; nameSpan.focus(); nameSpan.dataset.originalName = nameSpan.textContent; } };
              const handleEditCategoryEnd = (nameSpan) => { nameSpan.contentEditable = false; const novoNome = nameSpan.textContent.trim(); const originalName = nameSpan.dataset.originalName; const catId = nameSpan.closest('.categoria')?.dataset.categoryId; if (novoNome && novoNome !== originalName && catId) { const catIndex = categoriasDefinidas.findIndex(c => c.id === catId); if (catIndex > -1) { categoriasDefinidas[catIndex].nome = novoNome; } popularSelectCategorias(); _updateAllItemCategorySelects(); salvarDadosAtivos(); } else if(originalName) { nameSpan.textContent = originalName; } delete nameSpan.dataset.originalName; };
              const handleEditCategoryKeydown = (event, nameSpan) => { if (event.key === 'Enter') { event.preventDefault(); nameSpan.blur(); } else if (event.key === 'Escape') { nameSpan.textContent = nameSpan.dataset.originalName || ''; nameSpan.blur(); } };
              const handleDeleteCategory = (button) => { const catEl = button.closest('.categoria'); const catId = catEl?.dataset.categoryId; const nomeCat = catEl?.querySelector('.nome-categoria-display')?.textContent || 'esta categoria'; if (!catEl || !catId) return; if (confirm(`Excluir a categoria "${nomeCat}" e TODOS os seus itens?`)) { categoriasDefinidas = categoriasDefinidas.filter(c => c.id !== catId); Object.keys(dadosLista).forEach(itemId => { if (dadosLista[itemId].categoriaId === catId) delete dadosLista[itemId]; }); catEl.remove(); popularSelectCategorias(); _updateAllItemCategorySelects(); calcularTotalGeral(); salvarDadosAtivos(); alert(`Categoria "${nomeCat}" excluída.`); } };
              const handleBudgetChange = (inputElement) => { const catId = inputElement.closest('.categoria')?.dataset.categoryId; if (!catId) return; const budgetValue = inputElement.value; const catIndex = categoriasDefinidas.findIndex(c => c.id === catId); if (catIndex > -1) categoriasDefinidas[catIndex].budget = budgetValue === '' ? null : budgetValue; const catEl = inputElement.closest('.categoria'); if (catEl) calcularInfoCategoria(catEl); salvarDadosAtivos(); };
              const updateCategoryToggleButtonState = (catEl) => { if (!catEl) return; const button = catEl.querySelector('.btn-toggle-check-categoria'); if (!button) return; const items = catEl.querySelectorAll('.categoria-conteudo .item-lista:not(.item-hidden-by-filter):not(.hidden)'); const anyChecked = Array.from(items).some(item => item.querySelector('.item-check')?.checked); button.textContent = anyChecked ? '⬜' : '☑️'; button.title = anyChecked ? 'Desmarcar Todos os Itens' : 'Marcar Todos os Itens'; };
              const handleToggleCheckCategoryItems = (button) => { const catEl = button.closest('.categoria'); if (!catEl) return; const items = catEl.querySelectorAll('.categoria-conteudo .item-lista:not(.item-hidden-by-filter):not(.hidden)'); if (items.length === 0) return; const anyChecked = Array.from(items).some(item => item.querySelector('.item-check')?.checked); const shouldBeChecked = !anyChecked; items.forEach(item => { const checkbox = item.querySelector('.item-check'); const itemId = item.dataset.itemId; if (checkbox) checkbox.checked = shouldBeChecked; if (itemId && dadosLista[itemId]) dadosLista[itemId].checked = shouldBeChecked; }); button.textContent = shouldBeChecked ? '⬜' : '☑️'; button.title = shouldBeChecked ? 'Desmarcar Todos os Itens' : 'Marcar Todos os Itens'; calcularInfoCategoria(catEl); calcularTotalGeral(); salvarDadosAtivos(); };
              const handleDeleteAllCategoryItems = (button) => {
                const catEl = button.closest('.categoria'); if (!catEl) return;
                const catId = catEl.dataset.categoryId; const nomeCat = catEl.querySelector('.nome-categoria-display')?.textContent || 'esta categoria';
                const itemsInSection = catEl.querySelectorAll('.categoria-conteudo .item-lista');
                if (itemsInSection.length === 0) { alert(`Não há itens para excluir na categoria "${nomeCat}".`); return; }
                if (confirm(`Tem certeza que deseja excluir TODOS os ${itemsInSection.length} itens da categoria "${nomeCat}"?`)) {
                    let itensRemovidos = 0;
                    itemsInSection.forEach(itemEl => { const itemId = itemEl.dataset.itemId; if (itemId && dadosLista[itemId]) { delete dadosLista[itemId]; itemEl.remove(); itensRemovidos++; } });
                    if (itensRemovidos > 0) { console.log(`${itensRemovidos} itens removidos da categoria ${catId}`); calcularInfoCategoria(catEl); updateCategoryToggleButtonState(catEl); calcularTotalGeral(); salvarDadosAtivos(); alert(`${itensRemovidos} itens foram excluídos da categoria "${nomeCat}".`); }
                }
              };

              // --- Move Item Category Handler ---
              const handleMoveItemCategory = (event) => {
                const selectElement = event.target; const itemEl = selectElement.closest('.item-lista'); if (!itemEl) return;
                const itemId = itemEl.dataset.itemId; const newCategoryId = selectElement.value; const oldCategoryId = dadosLista[itemId]?.categoriaId;
                if (!itemId || !newCategoryId || oldCategoryId === newCategoryId) return;
                const oldCatEl = categoriasContainer.querySelector(`.categoria[data-category-id="${oldCategoryId}"]`); const newCatEl = categoriasContainer.querySelector(`.categoria[data-category-id="${newCategoryId}"]`); const newCatList = newCatEl?.querySelector('.lista-itens');
                if (!newCatEl || !newCatList) { console.error(`Categoria de destino ${newCategoryId} não encontrada no DOM.`); selectElement.value = oldCategoryId; return; }
                dadosLista[itemId].categoriaId = newCategoryId; dadosLista[itemId].subcategoriaId = `${newCategoryId}-geral`;
                newCatList.appendChild(itemEl); // Move element
                if (oldCatEl) { calcularInfoCategoria(oldCatEl); updateCategoryToggleButtonState(oldCatEl); }
                calcularInfoCategoria(newCatEl); updateCategoryToggleButtonState(newCatEl);
                // No need to recalculate total geral here, already done by filter/item changes
                aplicarFiltrosVisibilidadeItens(); // Apply filters to potentially hide/show the moved item
                salvarDadosAtivos();
              };


             // --- Persistência ---
             const salvarDadosAtivos = () => {
                 try {
                     const categoriasDOM = Array.from(categoriasContainer.querySelectorAll('.categoria'));
                     const ordemAtualizada = categoriasDOM.map(el => el.dataset.categoryId);
                     const novasDefinicoes = ordemAtualizada.map(id => {
                         let definicao = categoriasDefinidas.find(c => c.id === id);
                         const catEl = categoriasContainer.querySelector(`.categoria[data-category-id="${id}"]`);
                         if (catEl) {
                             if (!definicao) definicao = { id: id };
                             definicao.nome = catEl.querySelector('.nome-categoria-display')?.textContent || '?';
                             definicao.emoji = catEl.querySelector('.emoji')?.textContent || '?';
                             definicao.color = catEl.querySelector('h2.toggle-categoria')?.style.backgroundColor || null;
                             definicao.budget = catEl.querySelector('.input-budget-categoria')?.value || null;
                             if (definicao.budget === '') definicao.budget = null;
                             return definicao;
                         }
                         return null;
                     }).filter(Boolean);
                     categoriasDefinidas = novasDefinicoes;

                     const d = {
                         listaTitulo,
                         dataCompra: dataCompraInput.value,
                         itens: dadosLista,
                         categoriasDefinidas,
                         categoriasExpandidas: Array.from(categoriasContainer.querySelectorAll('.categoria.expanded')).map(c => c.dataset.categoryId),
                         unselectedVisible: unselectedItemsVisible,
                         alreadyHaveVisible: alreadyHaveItemsVisible,
                         orcamentoTotal: orcamentoTotal // NEW: Save total budget
                     };
                     localStorage.setItem(KEY_STORAGE_ATIVA, JSON.stringify(d));
                 } catch (e) { console.error("Salvar Ativos:", e); }
             };

             const carregarDadosAtivos = () => {
                 const s = localStorage.getItem(KEY_STORAGE_ATIVA);
                 let ok = false;
                 if (s) {
                     try {
                         const d = JSON.parse(s);
                         listaTitulo = d.listaTitulo || 'Lista de Compras Avançada';
                         dadosLista = d.itens || {};
                         unselectedItemsVisible = d.unselectedVisible !== undefined ? d.unselectedVisible : true;
                         alreadyHaveItemsVisible = d.alreadyHaveVisible !== undefined ? d.alreadyHaveVisible : true;
                         orcamentoTotal = d.orcamentoTotal !== undefined ? d.orcamentoTotal : null; // NEW: Load total budget
                         categoriasDefinidas = d.categoriasDefinidas || [];

                         aplicarEstilosTitulo();
                         categoriasContainer.innerHTML = ''; // Clear before rebuilding

                         if (categoriasDefinidas.length > 0) {
                             categoriasDefinidas.forEach(catDef => _criarEstruturaCategoriaHTML(catDef.id, catDef.nome, catDef.emoji, catDef.color, catDef.budget));
                         } else {
                             console.warn("Nenhuma definição de categoria encontrada.");
                             // Consider maybe calling _criarEstruturasPadrao() here if desired
                             ok = false; // Or handle as appropriate
                         }

                         Object.values(dadosLista).forEach(item => adicionarItemNaCategoria(item, item.categoriaId, item.subcategoriaId));
                         dataCompraInput.value = d.dataCompra || '';

                         // NEW: Restore total budget input value and format it
                         if (inputOrcamentoTotal) {
                             if (orcamentoTotal !== null && !isNaN(orcamentoTotal)) {
                                inputOrcamentoTotal.value = parseFloat(orcamentoTotal).toFixed(2);
                             } else {
                                inputOrcamentoTotal.value = '';
                             }
                         }

                         restaurarEstadoCategorias(d.categoriasExpandidas || []);

                         categoriasContainer.querySelectorAll('.categoria').forEach(catEl => {
                             updateCategoryToggleButtonState(catEl);
                             calcularInfoCategoria(catEl);
                             const budgetInput = catEl.querySelector('.input-budget-categoria');
                             if (budgetInput && budgetInput.value) handleBudgetInputBlur({ target: budgetInput });
                         });

                         aplicarFiltrosVisibilidadeItens(); // Apply filters *before* final total calculation
                         calcularTotalGeral(); // Calculate total *after* items and filters are applied

                         ok = true;
                     } catch (e) {
                         console.error("Carregar Ativos:", e);
                         localStorage.removeItem(KEY_STORAGE_ATIVA);
                         ok = false;
                     }
                 }
                 if (!ok) {
                    aplicarEstilosTitulo();
                    // Handle case where loading failed or no data exists
                    // Maybe call _criarEstruturasPadrao() and popularListaInicial() here
                 }
                 return ok;
             };
             const restaurarEstadoCategorias = (expandidas = []) => { categoriasContainer.querySelectorAll('.categoria').forEach(cat => { const id = cat.dataset.categoryId; const isExp = expandidas.includes(id); cat.classList.toggle('expanded', isExp); const ind = cat.querySelector('.toggle-indicator'); if (ind) ind.textContent = isExp ? '▲' : '▼'; }); };

             // --- Arquivamento ---
             const salvarArquivos = () => { try { localStorage.setItem(KEY_STORAGE_ARQUIVOS, JSON.stringify(arquivos)); popularDropdownArquivos(); } catch (e) { console.error("Salvar Arquivos:", e); alert("Erro ao salvar arquivos."); } };
             const carregarArquivos = () => { const s = localStorage.getItem(KEY_STORAGE_ARQUIVOS); if (s) { try { arquivos = JSON.parse(s); } catch (e) { console.error("Carregar Arquivos:", e); localStorage.removeItem(KEY_STORAGE_ARQUIVOS); arquivos = {}; } } else arquivos = {}; popularDropdownArquivos(); };
             const popularDropdownArquivos = () => { selectArquivos.innerHTML = '<option value="">Selecione...</option>'; Object.keys(arquivos).sort().reverse().forEach(k => { const o = document.createElement('option'); o.value = k; o.textContent = k.replace(/_/g, ' '); selectArquivos.appendChild(o); }); handleSelecaoArquivoChange(); };
             const salvarListaNoHistorico = () => { salvarDadosAtivos(); const k = formatarDataHoraParaChave(); const dadosAtivosString = localStorage.getItem(KEY_STORAGE_ATIVA); if (dadosAtivosString) { arquivos[k] = JSON.parse(dadosAtivosString); salvarArquivos(); alert(`Lista salva no histórico como: ${k.replace(/_/g, ' ')}`); } else { alert("Erro: Não foi possível ler os dados ativos para salvar no histórico."); } };
             const carregarListaArquivada = () => { const k = selectArquivos.value; if (!k || !arquivos[k]) return; if (!confirm(`Carregar "${k.replace(/_/g, ' ')}"?\nA lista ativa atual será substituída na tela.`)) return; const d = arquivos[k]; localStorage.setItem(KEY_STORAGE_ATIVA, JSON.stringify(d)); if (carregarDadosAtivos()) { popularSelectCategorias(); _updateAllItemCategorySelects(); alert(`Lista "${k.replace(/_/g, ' ')}" carregada e definida como ativa.`); } else { alert("Erro ao carregar a lista do histórico."); } };
             const deletarArquivo = () => { const k = selectArquivos.value; if (!k || !arquivos[k]) return; if (confirm(`Deletar permanentemente o arquivo "${k.replace(/_/g, ' ')}"?`)) { delete arquivos[k]; salvarArquivos(); alert(`Arquivo "${k.replace(/_/g, ' ')}" deletado.`); } };
             const handleSelecaoArquivoChange = () => { const sel = selectArquivos.value !== ""; btnCarregarArquivo.disabled = !sel; btnDeletarArquivo.disabled = !sel; }

              // --- Funções de Ordenação de Itens ---
              const ordenarItensSubcategoria = (ulElement, sortType, sortDirection) => { if (!ulElement) return; const liElements = Array.from(ulElement.querySelectorAll(':scope > .item-lista')); if (liElements.length < 2) return; const itemsData = liElements.map(li => ({ element: li, checked: li.querySelector('.item-check')?.checked || false, alreadyHave: li.classList.contains('item-already-have'), name: normalizarTexto(li.querySelector('.item-nome')?.textContent || ''), price: parseFloat(li.querySelector('.input-preco')?.value) || 0 })); const compareFn = (a, b) => { switch (sortType) { case 'checked': return sortDirection === 'desc' ? (b.checked - a.checked) : (a.checked - b.checked); case 'alreadyHave': return sortDirection === 'asc' ? (a.alreadyHave - b.alreadyHave) : (b.alreadyHave - a.alreadyHave); case 'name': return sortDirection === 'asc' ? a.name.localeCompare(b.name) : b.name.localeCompare(a.name); case 'price': return sortDirection === 'asc' ? a.price - b.price : b.price - a.price; default: return 0; } }; itemsData.sort(compareFn); itemsData.forEach(item => ulElement.appendChild(item.element)); const sortControlsDiv = ulElement.previousElementSibling; if (sortControlsDiv && sortControlsDiv.classList.contains('ordenacao-controles-categoria')) { sortControlsDiv.querySelectorAll('.btn-sort').forEach(btn => btn.classList.remove('active-sort')); const activeButton = sortControlsDiv.querySelector(`.btn-sort[data-sort-type="${sortType}"][data-sort-direction="${sortDirection}"]`); if (activeButton) activeButton.classList.add('active-sort'); } };

              // --- Funções Adicionais ---
              const recolherTodasAbas = () => { categoriasContainer.querySelectorAll('.categoria').forEach(cat => { cat.classList.remove('expanded'); const ind = cat.querySelector('.toggle-indicator'); if (ind) ind.textContent = '▼'; }); salvarDadosAtivos(); };

              // --- Criação de Categoria HTML ---
              const _criarEstruturaCategoriaHTML = (id, nome, emoji = '🆕', cor = null, budget = null) => {
                  if (categoriasContainer.querySelector(`.categoria[data-category-id="${id}"]`)) return categoriasContainer.querySelector(`.categoria[data-category-id="${id}"]`);
                  const novaSection = document.createElement('section'); novaSection.className = 'categoria'; novaSection.dataset.categoryId = id; novaSection.draggable = true;
                  const h2 = document.createElement('h2'); h2.className = 'toggle-categoria'; if (cor) h2.style.backgroundColor = cor; else { const baseIdMatch = id.match(/^(feira-semanal|feira-mensal|limpeza|higiene|condimentos|outros)(?:-|$)/); if (baseIdMatch && baseIdMatch[1]) novaSection.classList.add(`categoria-${baseIdMatch[1]}`); else if (id.startsWith('nova-')) novaSection.classList.add('categoria-nova-generica'); }
                  h2.innerHTML = `
                      <span class="drag-handle" title="Arraste para reordenar">⠿</span>
                      <span class="titulo-categoria"><span class="emoji">${emoji}</span><span class="nome-categoria-display">${nome}</span></span>
                      <div class="cabecalho-acoes">
                           <!-- Category specific filters (Icons) -->
                           <button class="btn-toggle-cat-unselected" title="Ocultar Não Comprar (Categoria)" data-visible="true">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="m10.79 12.912-1.614-1.615a3.5 3.5 0 0 1-4.474-4.474l-2.06-2.06C.938 6.278 0 8 0 8s3 5.5 8 5.5a7.029 7.029 0 0 0 2.79-.588M5.21 3.088A7.028 7.028 0 0 1 8 2.5c5 0 8 5.5 8 5.5s-.939 1.721-2.641 3.238l-2.062-2.062a3.5 3.5 0 0 0-4.474-4.474z"/><path d="M5.525 7.646a2.5 2.5 0 0 0 2.829 2.829l-2.83-2.829zm4.95.708-2.829-2.83a2.5 2.5 0 0 1 2.829 2.829zm3.171 6-12-12 .708-.708 12 12z"/></svg>
                           </button>
                           <button class="btn-toggle-cat-already" title="Ocultar 'Já Tenho' (Categoria)" data-visible="true">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M8.707 1.5a1 1 0 0 0-1.414 0L.646 8.146a.5.5 0 0 0 .708.708L8 2.207l6.646 6.647a.5.5 0 0 0 .708-.708L13 5.793V2.5a.5.5 0 0 0-.5-.5h-1a.5.5 0 0 0-.5.5v1.293z"/><path d="m8 3.293 6 6V13.5a1.5 1.5 0 0 1-1.5 1.5h-9A1.5 1.5 0 0 1 2 13.5V9.293z"/></svg>
                           </button>
                           <!-- Other category actions -->
                           <button class="btn-toggle-check-categoria" title="Marcar/Desmarcar Todos">⬜</button>
                           <button class="btn-color-categoria" title="Mudar Cor">🎨</button>
                           <button class="btn-edit-categoria" title="Editar Nome">✏️</button>
                           <button class="btn-delete-all-items-categoria" title="Excluir Todos os Itens Desta Categoria">
                               <!-- Red X Icon -->
                               <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="#ff4d4d" class="bi bi-trash-x-fill" viewBox="0 0 16 16">
                                   <path d="M2.5 1a1 1 0 0 0-1 1v1a1 1 0 0 0 1 1H3v9a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V4h.5a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H10a1 1 0 0 0-1-1H7a1 1 0 0 0-1 1zm3 4a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 .5-.5M8 5a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-1 0v-7A.5.5 0 0 1 8 5m3 .5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 1 0"/>
                                   <path d="M6.854 5.146a.5.5 0 1 0-.708.708L7.293 7 6.146 8.146a.5.5 0 1 0 .708.708L8 7.707l1.146 1.147a.5.5 0 1 0 .708-.708L8.707 7l1.147-1.146a.5.5 0 0 0-.708-.708L8 6.293z"/>
                               </svg>
                           </button>
                           <button class="btn-delete-categoria" title="Excluir Categoria">🗑️</button>
                      </div>
                      <div class="cabecalho-info">
                           <span><span class="label">Itens:</span> <span class="valor" id="contagem-cat-${id}">0</span></span>
                           <span><span class="label">Preço:</span> <span class="valor" id="preco-cat-${id}">R$ 0,00</span></span>
                           <div class="budget-input-wrapper">
                               <label for="budget-${id}" class="label">Orçamento:</label>
                               <input type="number" step="0.01" placeholder="R$ 0,00" class="input-budget-categoria" id="budget-${id}" value="${budget !== null ? budget : ''}" inputmode="decimal" title="Orçamento da categoria">
                               <span class="budget-warning" id="budget-warning-${id}">💰 Excedido!</span>
                           </div>
                      </div>
                      <span class="toggle-indicator">▼</span>`;
                  novaSection.appendChild(h2);
                  const conteudoDiv = document.createElement('div'); conteudoDiv.className = 'categoria-conteudo';
                  conteudoDiv.innerHTML = `
                       <div class="ordenacao-controles-categoria" data-controls-for="${id}-geral">
                           <button class="btn-sort" data-sort-type="checked" data-sort-direction="desc" title="Ordenar por Comprar">✓</button>
                           <button class="btn-sort" data-sort-type="alreadyHave" data-sort-direction="asc" title="Ordenar por Já Tenho">🏠</button>
                           <button class="btn-sort" data-sort-type="name" data-sort-direction="asc" title="Ordenar A-Z">A-Z</button>
                           <button class="btn-sort" data-sort-type="name" data-sort-direction="desc" title="Ordenar Z-A">Z-A</button>
                           <button class="btn-sort" data-sort-type="price" data-sort-direction="asc" title="Ordenar Preço Crescente">Preço ↑</button>
                           <button class="btn-sort" data-sort-type="price" data-sort-direction="desc" title="Ordenar Preço Decrescente">Preço ↓</button>
                       </div>
                       <ul class="lista-itens" data-subcategory="${id}-geral"></ul>
                       <div class="categoria-total">Total Selecionado: R$ 0.00</div>`;
                  novaSection.appendChild(conteudoDiv); categoriasContainer.appendChild(novaSection);
                  const budgetInput = novaSection.querySelector('.input-budget-categoria');
                  if (budgetInput) budgetInput.addEventListener('blur', handleBudgetInputBlur);
                  return novaSection;
              };
             const _criarEstruturasPadrao = () => { const padrao = [ { id: 'feira-semanal', nome: 'Feira Semanal', emoji: '🟢', budget: null }, { id: 'feira-mensal', nome: 'Feira Mensal / Reserva', emoji: '🔵', budget: null }, { id: 'limpeza', nome: 'Limpeza Doméstica', emoji: '🧼', budget: null }, { id: 'higiene', nome: 'Higiene Pessoal', emoji: '🧴', budget: null }, { id: 'condimentos', nome: 'Condimentos e Conservas', emoji: '🍳', budget: null }, { id: 'outros', nome: 'Outros Itens Úteis', emoji: '🛒', budget: null }, ]; padrao.forEach(p => _criarEstruturaCategoriaHTML(p.id, p.nome, p.emoji, null, p.budget)); categoriasDefinidas = padrao.map(p => ({ ...p, color: null })); };
              const criarNovaCategoria = () => { const nomeNova = prompt("Digite o nome da nova categoria:"); if (!nomeNova || nomeNova.trim() === "") { alert("Nome inválido."); return; } const nomeLimpo = nomeNova.trim(); const novoId = gerarIdCategoria(nomeLimpo); if (categoriasDefinidas.some(c => c.id === novoId)) { alert("Erro: ID de categoria já existe."); return; } const novaSection = _criarEstruturaCategoriaHTML(novoId, nomeLimpo, '🆕', null, null); categoriasDefinidas.push({ id: novoId, nome: nomeLimpo, emoji: '🆕', color: null, budget: null }); updateCategoryToggleButtonState(novaSection); popularSelectCategorias(); _updateAllItemCategorySelects(); novaSection.scrollIntoView({ behavior: 'smooth', block: 'start' }); salvarDadosAtivos(); alert(`Categoria "${nomeLimpo}" criada!`); };

             // --- Toggle Visibility Functions ---
             const toggleUnselectedItemsVisibility = () => { unselectedItemsVisible = !unselectedItemsVisible; aplicarFiltrosVisibilidadeItens(); btnToggleUnselected.title = unselectedItemsVisible ? 'Ocultar itens não marcados para compra' : 'Mostrar itens não marcados para compra'; salvarDadosAtivos(); }; // Update global button title
             const toggleAlreadyHaveItemsVisibility = () => { alreadyHaveItemsVisible = !alreadyHaveItemsVisible; aplicarFiltrosVisibilidadeItens(); btnToggleAlreadyHave.title = alreadyHaveItemsVisible ? "Ocultar itens marcados como 'Já Tenho'" : "Mostrar itens marcados como 'Já Tenho'"; salvarDadosAtivos(); }; // Update global button title

             // --- Category-specific Filter Toggles ---
             const handleToggleCategoryUnselected = (button) => {
                 const isVisible = button.dataset.visible === 'true'; const newVisibility = !isVisible; button.dataset.visible = newVisibility;
                 button.title = newVisibility ? 'Ocultar Não Comprar (Categoria)' : 'Mostrar Não Comprar (Categoria)';
                 // Update SVG inside button
                 button.innerHTML = newVisibility ? `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="m10.79 12.912-1.614-1.615a3.5 3.5 0 0 1-4.474-4.474l-2.06-2.06C.938 6.278 0 8 0 8s3 5.5 8 5.5a7.029 7.029 0 0 0 2.79-.588M5.21 3.088A7.028 7.028 0 0 1 8 2.5c5 0 8 5.5 8 5.5s-.939 1.721-2.641 3.238l-2.062-2.062a3.5 3.5 0 0 0-4.474-4.474z"/><path d="M5.525 7.646a2.5 2.5 0 0 0 2.829 2.829l-2.83-2.829zm4.95.708-2.829-2.83a2.5 2.5 0 0 1 2.829 2.829zm3.171 6-12-12 .708-.708 12 12z"/></svg>` : `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M16 8s-3-5.5-8-5.5S0 8 0 8s3 5.5 8 5.5S16 8 16 8M1.173 8a13 13 0 0 1 1.618-2.277A13 13 0 0 1 8 3.5a13 13 0 0 1 5.209 2.223A13 13 0 0 1 14.828 8a13 13 0 0 1-1.618 2.277A13 13 0 0 1 8 12.5a13 13 0 0 1-5.209-2.223A13 13 0 0 1 1.172 8z"/><path d="M8 5.5a2.5 2.5 0 1 0 0 5 2.5 2.5 0 0 0 0-5m0 4a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3"/></svg>`;
                 aplicarFiltrosVisibilidadeItens();
             };
             const handleToggleCategoryAlreadyHave = (button) => {
                 const isVisible = button.dataset.visible === 'true'; const newVisibility = !isVisible; button.dataset.visible = newVisibility;
                 button.title = newVisibility ? "Ocultar 'Já Tenho' (Categoria)" : "Mostrar 'Já Tenho' (Categoria)";
                 // Keep the same house icon, maybe change opacity/color via CSS if desired later
                 // button.innerHTML = ... (no change needed for icon itself)
                 aplicarFiltrosVisibilidadeItens();
             };


             // --- Combined function to apply ALL visibility filters ---
             const aplicarFiltrosVisibilidadeItens = () => {
                 const itens = categoriasContainer.querySelectorAll('.item-lista');
                 let recalcularGeralNecessario = false; // Flag to check if global total needs recalculation

                 itens.forEach(item => {
                     const isChecked = item.querySelector('.item-check')?.checked;
                     const isAlreadyHave = item.classList.contains('item-already-have');
                     const isHiddenBySearch = item.classList.contains('hidden');

                     // Get category specific filter states
                     const catEl = item.closest('.categoria');
                     const catBtnUnselected = catEl?.querySelector('.btn-toggle-cat-unselected');
                     const catBtnAlready = catEl?.querySelector('.btn-toggle-cat-already');

                     // Default to visible if buttons not found (shouldn't happen normally)
                     const catUnselectedVisible = catBtnUnselected ? catBtnUnselected.dataset.visible === 'true' : true;
                     const catAlreadyHaveVisible = catBtnAlready ? catBtnAlready.dataset.visible === 'true' : true;

                     // Determine if hidden by *any* applicable filter
                     const hideBecauseGlobalUnselected = !unselectedItemsVisible && !isChecked;
                     const hideBecauseCatUnselected = !catUnselectedVisible && !isChecked;
                     const hideBecauseGlobalAlready = !alreadyHaveItemsVisible && isAlreadyHave;
                     const hideBecauseCatAlready = !catAlreadyHaveVisible && isAlreadyHave;

                     const shouldBeHidden = isHiddenBySearch ||
                                           hideBecauseGlobalUnselected || hideBecauseCatUnselected ||
                                           hideBecauseGlobalAlready || hideBecauseCatAlready;

                     const wasHidden = item.classList.contains('item-hidden-by-filter');
                     item.classList.toggle('item-hidden-by-filter', shouldBeHidden);

                     // Check if visibility changed *and* the item affects the total
                     // This flag is important to avoid recalculating the total unnecessarily
                     if (wasHidden !== shouldBeHidden && isChecked && !isAlreadyHave) {
                         recalcularGeralNecessario = true;
                     }
                 });

                 // Recalculate category totals (always needed as item visibility might change within a category)
                 categoriasContainer.querySelectorAll('.categoria').forEach(calcularInfoCategoria);

                 // Recalculate global total ONLY if a relevant item's visibility changed OR if filters were toggled globally
                 // The check for flag `recalcularGeralNecessario` handles item changes.
                 // Global toggle button clicks will call this function, and then call calcularTotalGeral() explicitly afterwards if needed.
                 // However, it's safer and simpler to just recalculate the total here always after filters run.
                 calcularTotalGeral();
             };


             // --- Title Editing Handlers ---
             const handleTitleEditStart = (e) => { currentEditingTitle = listaTituloSpan.textContent; };
             const handleTitleEditEnd = (e) => { const novoTitulo = listaTituloSpan.textContent.trim(); if (novoTitulo && novoTitulo !== listaTitulo) listaTitulo = novoTitulo; else listaTituloSpan.textContent = listaTitulo; salvarDadosAtivos(); };
             const handleTitleEditKeydown = (e) => { if (e.key === 'Enter') { e.preventDefault(); listaTituloSpan.blur(); } else if (e.key === 'Escape') { listaTituloSpan.textContent = currentEditingTitle; listaTituloSpan.blur(); } };
             const aplicarEstilosTitulo = () => { if (listaTituloSpan) { listaTituloSpan.textContent = listaTitulo; } };

             // --- Text Generation for Export/Copy ---
             const gerarTextoLista = () => {
                 let content = `${listaTitulo}\nData: ${dataCompraInput.value || new Date().toLocaleDateString('pt-BR')}\n`;
                 // Add Total Budget info if set
                 if (orcamentoTotal !== null && !isNaN(orcamentoTotal)) {
                     content += `Orçamento Total: ${formatarMoeda(orcamentoTotal)}\n`;
                 }
                 content += `========================================\n\n`;

                 categoriasContainer.querySelectorAll('.categoria').forEach(cat => {
                     const nomeCat = cat.querySelector('.nome-categoria-display')?.textContent || cat.dataset.categoryId;
                     const emojiCat = cat.querySelector('.emoji')?.textContent || '';
                     const budgetInput = cat.querySelector('.input-budget-categoria');
                     const budgetValue = budgetInput ? parseFloat(budgetInput.value) : NaN;
                     const budgetStr = !isNaN(budgetValue) && budgetValue > 0 ? ` (Orçamento: ${formatarMoeda(budgetValue)})` : '';
                     const warningStr = cat.querySelector('.budget-warning')?.style.display !== 'none' ? ' [ORÇAMENTO EXCEDIDO]' : '';
                     content += `${emojiCat} ${nomeCat}${budgetStr}${warningStr}\n--------------------\n`;
                     let algumItemVisivelNaCategoria = false;
                     cat.querySelectorAll('.lista-itens .item-lista:not(.hidden):not(.item-hidden-by-filter)').forEach(itemEl => {
                         const alreadyHaveCheck = itemEl.querySelector('.item-already-have-check')?.checked ? '[✓ Já Tenho] ' : '[ ] ';
                         const check = itemEl.querySelector('.item-check')?.checked ? '[x Comprar] ' : '[_] ';
                         const nome = itemEl.querySelector('.item-nome')?.textContent || '?';
                         const qtd = itemEl.querySelector('.input-qtd')?.value || '0';
                         const precoUnit = parseFloat(itemEl.querySelector('.input-preco')?.value) || 0;
                         const totalItem = (parseFloat(qtd) || 0) * precoUnit;
                         content += `${alreadyHaveCheck}${check}${nome} (Qtd: ${qtd}, Preço: ${formatarMoeda(precoUnit)}) = ${formatarMoeda(totalItem)}\n`;
                         algumItemVisivelNaCategoria = true;
                     });
                     if (!algumItemVisivelNaCategoria) content += "(Nenhum item visível com filtros atuais)\n";
                     const totalCatStr = cat.querySelector('.categoria-total')?.textContent || '';
                     content += `${totalCatStr}\n\n`;
                 });
                 content += `========================================\n`;
                 const totalGeralStr = valorTotalGeralSpan.textContent;
                 content += `Produtos: ${contadorProdutosSpan.textContent} | Total: ${totalGeralStr}`;
                 // Add budget exceeding warning to export text
                 if (totalGeralDisplay.classList.contains('orcamento-excedido')) {
                    content += ` [ORÇAMENTO TOTAL EXCEDIDO!]`;
                 }
                 content += `\n`;
                 return content;
            }

             // --- Export Function ---
             const exportarListaAtualTxt = () => { const content = gerarTextoLista(); const blob = new Blob([content], { type: 'text/plain;charset=utf-8' }); const link = document.createElement("a"); const url = URL.createObjectURL(blob); link.setAttribute("href", url); const dataSimples = (dataCompraInput.value || new Date().toISOString().slice(0,10)).replace(/-/g,''); link.setAttribute("download", `${normalizarTexto(listaTitulo).replace(/\s+/g, '_')}_${dataSimples}.txt`); link.style.visibility = 'hidden'; document.body.appendChild(link); link.click(); document.body.removeChild(link); URL.revokeObjectURL(url); };

             // --- Copy to Clipboard Function ---
             const copiarListaParaClipboard = async () => { const content = gerarTextoLista(); try { await navigator.clipboard.writeText(content); alert('Lista copiada para a área de transferência!'); } catch (err) { console.error('Falha ao copiar texto: ', err); alert('Erro ao copiar a lista. Verifique as permissões do navegador ou tente novamente.'); } };

             // --- Drag and Drop Handlers ---
             function handleDragStart(e) { const categoryElement = e.target.closest('.categoria'); if (!categoryElement) { e.preventDefault(); return; } draggedCategory = categoryElement; e.dataTransfer.effectAllowed = 'move'; e.dataTransfer.setData('text/plain', draggedCategory.dataset.categoryId); setTimeout(() => { if(draggedCategory) draggedCategory.classList.add('dragging'); }, 0); }
             function handleDragEnd(e) { if (draggedCategory) draggedCategory.classList.remove('dragging'); categoriasContainer.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over')); draggedCategory = null; salvarDadosAtivos(); }
             function handleDragOver(e) { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; const targetCategory = e.target.closest('.categoria'); categoriasContainer.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over')); if (targetCategory && targetCategory !== draggedCategory) { targetCategory.classList.add('drag-over'); } }
             function handleDragLeave(e) { const currentTarget = e.currentTarget; if (currentTarget.contains(e.relatedTarget)) { return; } if (currentTarget.classList.contains('drag-over')) { currentTarget.classList.remove('drag-over'); } }
             function handleDrop(e) { e.preventDefault(); e.stopPropagation(); if (!draggedCategory) return; const dropTarget = e.target; const targetCategory = dropTarget.closest('.categoria'); draggedCategory.classList.remove('dragging'); categoriasContainer.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over')); if (targetCategory && targetCategory !== draggedCategory) { const rect = targetCategory.getBoundingClientRect(); const offsetY = e.clientY - rect.top; const threshold = rect.height / 2; if (offsetY < threshold) categoriasContainer.insertBefore(draggedCategory, targetCategory); else categoriasContainer.insertBefore(draggedCategory, targetCategory.nextSibling); } else if (!targetCategory && draggedCategory.parentNode === categoriasContainer) { categoriasContainer.appendChild(draggedCategory); } draggedCategory = null; /* Saving order is handled in handleDragEnd */ }


             // --- Color Picker Handlers ---
             function openColorPicker(button) { currentPopupTargetType = 'category'; colorPickerPopup.innerHTML = ''; const colorsToUse = DEFAULT_COLORS; colorsToUse.forEach(color => { const swatch = document.createElement('div'); swatch.className = 'color-swatch'; swatch.style.backgroundColor = color; swatch.dataset.color = color; colorPickerPopup.appendChild(swatch); }); const rect = button.getBoundingClientRect(); colorPickerPopup.style.top = `${window.scrollY + rect.bottom + 5}px`; colorPickerPopup.style.left = `${window.scrollX + rect.left}px`; colorPickerPopup.style.display = 'flex'; delete colorPickerPopup.dataset.editingCategory; const categoriaEl = button.closest('.categoria'); if (categoriaEl) colorPickerPopup.dataset.editingCategory = categoriaEl.dataset.categoryId; }
             function selectColor(e) { if (!e.target.classList.contains('color-swatch')) return; const chosenColor = e.target.dataset.color; if (!chosenColor) return; const categoryId = colorPickerPopup.dataset.editingCategory; if (!categoryId) return; const catEl = categoriasContainer.querySelector(`.categoria[data-category-id="${categoryId}"]`); const h2 = catEl?.querySelector('h2.toggle-categoria'); if (h2) h2.style.backgroundColor = chosenColor; const catIndex = categoriasDefinidas.findIndex(c => c.id === categoryId); if (catIndex > -1) categoriasDefinidas[catIndex].color = chosenColor; closeColorPicker(); salvarDadosAtivos(); }
             function closeColorPicker() { colorPickerPopup.style.display = 'none'; delete colorPickerPopup.dataset.editingCategory; currentPopupTargetType = null; }
             document.addEventListener('click', (e) => { if (colorPickerPopup.style.display === 'flex' && !colorPickerPopup.contains(e.target) && !e.target.classList.contains('btn-color-categoria')) { closeColorPicker(); } });

             // --- Clear All Lists Handler ---
            const handleZerarListas = () => {
                if (!confirm('Tem certeza que deseja excluir TODOS os itens de TODAS as categorias? Esta ação não pode ser desfeita.')) { return; }
                let totalItensRemovidos = 0;
                categoriasContainer.querySelectorAll('.categoria').forEach(catEl => { const catId = catEl.dataset.categoryId; const itemsInSection = catEl.querySelectorAll('.categoria-conteudo .item-lista'); itemsInSection.forEach(itemEl => { const itemId = itemEl.dataset.itemId; if (itemId && dadosLista[itemId]) { delete dadosLista[itemId]; itemEl.remove(); totalItensRemovidos++; } }); calcularInfoCategoria(catEl); updateCategoryToggleButtonState(catEl); });
                if (totalItensRemovidos > 0) { console.log(`${totalItensRemovidos} itens removidos de todas as categorias.`); calcularTotalGeral(); salvarDadosAtivos(); alert(`${totalItensRemovidos} itens foram excluídos de todas as listas.`); } else { alert("Nenhum item encontrado para excluir."); }
            };

             // --- Helper: Populate a single item category select ---
             const _populateSingleItemCategorySelect = (selectElement, selectedCategoryId) => {
                if (!selectElement) return; selectElement.innerHTML = '';
                categoriasDefinidas.forEach(catDef => { const option = document.createElement('option'); option.value = catDef.id; option.textContent = catDef.nome; selectElement.appendChild(option); });
                if (categoriasDefinidas.some(c => c.id === selectedCategoryId)) { selectElement.value = selectedCategoryId; } else if (selectElement.options.length > 0) { selectElement.selectedIndex = 0; }
             };

             // --- Helper: Update all item category selects ---
             const _updateAllItemCategorySelects = () => {
                 const allSelects = categoriasContainer.querySelectorAll('.item-categoria-select');
                 allSelects.forEach(selectEl => { const itemEl = selectEl.closest('.item-lista'); const itemId = itemEl?.dataset.itemId; if (itemId && dadosLista[itemId]) { _populateSingleItemCategorySelect(selectEl, dadosLista[itemId].categoriaId); } });
             };


             // --- Inicialização ---
             const popularSelectCategorias = () => { const c = categoriasContainer.querySelectorAll('.categoria'); const valorAtual = novoProdutoCategoriaSelect.value; novoProdutoCategoriaSelect.innerHTML = ''; c.forEach(cat => { const o=document.createElement('option'); const n=cat.querySelector('.nome-categoria-display'); let t = n ? n.textContent.trim() : 'Cat s/ nome'; o.value = cat.dataset.categoryId; o.textContent = t || cat.dataset.categoryId; novoProdutoCategoriaSelect.appendChild(o); }); if (valorAtual && novoProdutoCategoriaSelect.querySelector(`option[value="${valorAtual}"]`)) { novoProdutoCategoriaSelect.value = valorAtual; } else if (novoProdutoCategoriaSelect.options.length > 0) { novoProdutoCategoriaSelect.selectedIndex = 0;} };
             const inicializarApp = () => {
                 console.log("Inicializando App v4.11.4 - Orçamento Total..."); // Version updated
                 carregarArquivos();
                 if (!carregarDadosAtivos()) {
                    console.log("Nenhuma lista ativa. Inicializando padrão.");
                    categoriasContainer.innerHTML = '';
                    _criarEstruturasPadrao();
                    popularListaInicial();
                    aplicarEstilosTitulo();
                    categoriasContainer.querySelectorAll('.categoria').forEach(catEl => {
                        updateCategoryToggleButtonState(catEl);
                        calcularInfoCategoria(catEl);
                        const budgetInput = catEl.querySelector('.input-budget-categoria');
                        if (budgetInput && budgetInput.value) handleBudgetInputBlur({target: budgetInput});
                    });
                    calcularTotalGeral(); // Calculate initial total
                    salvarDadosAtivos(); // Save default state
                 } else {
                    console.log("Lista ativa carregada.");
                    // Total calculation and budget check happens inside carregarDadosAtivos
                 }
                 popularSelectCategorias();
                 _updateAllItemCategorySelects(); // Populate item dropdowns after initial load/setup

                 // --- Listeners Estáticos ---
                 addProdutoBtn.addEventListener('click', () => {
                    const nomeNovo = novoProdutoNomeInput.value.trim(); const catId = novoProdutoCategoriaSelect.value;
                    if (!nomeNovo || !catId) { alert('Preencha nome e selecione uma categoria.'); return; }
                    const nomeNovoNormalizado = normalizarTexto(nomeNovo); let itemExatoEncontrado = null; let itemSimilarEncontrado = null;
                    const itensExistentes = Object.values(dadosLista);
                    for (const itemExistente of itensExistentes) { const nomeExistenteNormalizado = normalizarTexto(itemExistente.nome); if (nomeExistenteNormalizado === nomeNovoNormalizado) { itemExatoEncontrado = itemExistente; break; } if (!itemExatoEncontrado) { const palavrasNovo = nomeNovoNormalizado.split(' '); const palavrasExistente = nomeExistenteNormalizado.split(' '); if (nomeNovoNormalizado.includes(nomeExistenteNormalizado) || nomeExistenteNormalizado.includes(nomeNovoNormalizado) || (palavrasNovo.length > 0 && palavrasExistente.length > 0 && palavrasNovo[0] === palavrasExistente[0])) { if (!itemSimilarEncontrado) itemSimilarEncontrado = itemExistente; } } }
                    if (itemExatoEncontrado) { alert(`O item "${nomeNovo}" já existe na lista!`); return; }
                    if (itemSimilarEncontrado) { const confirmar = confirm(`"${nomeNovo}" é parecido com um item existente ("${itemSimilarEncontrado.nome}"). Deseja adicionar mesmo assim?`); if (!confirmar) return; }
                    const d = { id: gerarIdUnico(), nome: nomeNovo, checked: false, alreadyHave: false, qtd: '1.0', preco: '' }; adicionarItemNaCategoria(d, catId, `${catId}-geral`); novoProdutoNomeInput.value = ''; const catEl = categoriasContainer.querySelector(`.categoria[data-category-id="${catId}"]`); if (catEl) { calcularInfoCategoria(catEl); if (!catEl.classList.contains('expanded')) catEl.querySelector('.toggle-categoria')?.click(); }
                    calcularTotalGeral(); // Recalculate total after adding
                    salvarDadosAtivos();
                 });

                 btnSalvarHistorico.addEventListener('click', salvarListaNoHistorico); selectArquivos.addEventListener('change', handleSelecaoArquivoChange); btnCarregarArquivo.addEventListener('click', carregarListaArquivada); btnDeletarArquivo.addEventListener('click', deletarArquivo); btnRecolherAbas.addEventListener('click', recolherTodasAbas); btnCriarCategoria.addEventListener('click', criarNovaCategoria);
                 btnToggleUnselected.addEventListener('click', toggleUnselectedItemsVisibility); // Global
                 btnToggleAlreadyHave.addEventListener('click', toggleAlreadyHaveItemsVisibility); // Global
                 btnZerarListas.addEventListener('click', handleZerarListas);
                 btnExportarLista.addEventListener('click', exportarListaAtualTxt);
                 btnCopiarLista.addEventListener('click', copiarListaParaClipboard);
                 btnImportarLista.addEventListener('click', () => importFileInput.click());
                 importFileInput.addEventListener('change', handleImportarArquivo);
                 dataCompraInput.addEventListener('change', salvarDadosAtivos);
                 filtroInput.addEventListener('input', () => { const t = normalizarTexto(filtroInput.value); categoriasContainer.querySelectorAll('.item-lista').forEach(item => { const n = normalizarTexto(item.querySelector('.item-nome')?.textContent || ''); item.classList.toggle('hidden', !n.includes(t)); }); aplicarFiltrosVisibilidadeItens(); }); // aplicarFiltros also calls calcularTotalGeral

                 // --- Title Edit Listeners ---
                 listaTituloSpan.addEventListener('focus', handleTitleEditStart); listaTituloSpan.addEventListener('blur', handleTitleEditEnd); listaTituloSpan.addEventListener('keydown', handleTitleEditKeydown);

                 // --- NEW: Total Budget Listeners ---
                 inputOrcamentoTotal.addEventListener('input', handleOrcamentoTotalChange);
                 inputOrcamentoTotal.addEventListener('blur', handleOrcamentoTotalBlur);

                 // --- Listeners Dinâmicos (Delegação) ---
                 categoriasContainer.addEventListener('click', (event) => {
                     const target = event.target;
                     const btnEditCat = target.closest('.btn-edit-categoria'); const btnDeleteCat = target.closest('.btn-delete-categoria'); const btnColorCat = target.closest('.btn-color-categoria'); const btnToggleCheckCat = target.closest('.btn-toggle-check-categoria'); const btnDeleteAllItemsCat = target.closest('.btn-delete-all-items-categoria');
                     const btnToggleCatUnselected = target.closest('.btn-toggle-cat-unselected'); const btnToggleCatAlready = target.closest('.btn-toggle-cat-already');
                     const btnSort = target.closest('.btn-sort'); const btnQtdDown = target.closest('.btn-qtd-down'); const btnQtdUp = target.closest('.btn-qtd-up');
                     const headerCategoria = target.closest('.toggle-categoria');

                     if (btnEditCat) handleEditCategoryStart(btnEditCat);
                     else if (btnDeleteCat) handleDeleteCategory(btnDeleteCat);
                     else if (btnColorCat) openColorPicker(btnColorCat);
                     else if (btnToggleCheckCat) handleToggleCheckCategoryItems(btnToggleCheckCat);
                     else if (btnDeleteAllItemsCat) handleDeleteAllCategoryItems(btnDeleteAllItemsCat);
                     else if (btnToggleCatUnselected) handleToggleCategoryUnselected(btnToggleCatUnselected);
                     else if (btnToggleCatAlready) handleToggleCategoryAlreadyHave(btnToggleCatAlready);
                     else if (btnSort) { const sortType = btnSort.dataset.sortType; const sortDirection = btnSort.dataset.sortDirection; const sortControlsDiv = btnSort.closest('.ordenacao-controles-categoria'); const ulToSort = sortControlsDiv?.nextElementSibling; if (ulToSort && ulToSort.tagName === 'UL') ordenarItensSubcategoria(ulToSort, sortType, sortDirection); }
                     else if (btnQtdDown || btnQtdUp) handleStepperClick(target);
                     else if (headerCategoria && !target.closest('.cabecalho-acoes') && !target.closest('.nome-categoria-display[contenteditable="true"]') && !target.closest('.cabecalho-info') && !target.closest('.drag-handle') && !target.closest('.input-budget-categoria')) { const catEl = headerCategoria.closest('.categoria'); if(catEl) { catEl.classList.toggle('expanded'); const ind = headerCategoria.querySelector('.toggle-indicator'); if(ind) ind.textContent = catEl.classList.contains('expanded') ? '▲' : '▼'; salvarDadosAtivos(); } }
                 });
                 categoriasContainer.addEventListener('change', (event) => { if (event.target.classList.contains('item-categoria-select')) { handleMoveItemCategory(event); } });
                 categoriasContainer.addEventListener('input', (e) => { if (e.target.classList.contains('input-budget-categoria')) handleBudgetChange(e.target); });
                 categoriasContainer.addEventListener('focusout', (e) => { if (e.target.classList.contains('nome-categoria-display') && e.target.isContentEditable) handleEditCategoryEnd(e.target); });
                 categoriasContainer.addEventListener('keydown', (e) => { if (e.target.classList.contains('nome-categoria-display') && e.target.isContentEditable) handleEditCategoryKeydown(e, e.target); });
                 // Use capturing phase for blur on category budget to ensure formatting happens
                 categoriasContainer.addEventListener('blur', (e) => { if (e.target.classList.contains('input-budget-categoria')) { handleBudgetInputBlur(e); } }, true);

                 // --- Listeners de Drag and Drop & Color Picker ---
                 categoriasContainer.addEventListener('dragstart', handleDragStart); categoriasContainer.addEventListener('dragend', handleDragEnd); categoriasContainer.addEventListener('dragover', handleDragOver); categoriasContainer.addEventListener('dragleave', handleDragLeave); categoriasContainer.addEventListener('drop', handleDrop);
                 colorPickerPopup.addEventListener('click', selectColor);
                 console.log("App inicializado e listeners configurados.");
             };

             // --- NEW: Import Function ---
             const handleImportarArquivo = (event) => {
                const file = event.target.files[0]; if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    const content = e.target.result; let importedData; let itensImportados = 0; let itensIgnorados = 0;
                    try { importedData = JSON.parse(content); } catch (error) { console.error("Erro ao parsear JSON:", error); alert("Erro ao ler o arquivo. Verifique se é um arquivo JSON válido."); event.target.value = null; return; }
                    if (!Array.isArray(importedData)) { alert("Erro: O arquivo JSON deve conter um array (lista) de itens."); event.target.value = null; return; }

                    let defaultCategoryId = novoProdutoCategoriaSelect.value;
                    if (!categoriasDefinidas.some(c => c.id === defaultCategoryId)) { const primeiraCategoria = categoriasContainer.querySelector('.categoria'); if (primeiraCategoria) defaultCategoryId = primeiraCategoria.dataset.categoryId; else { alert("Nenhuma categoria encontrada para importar os itens. Crie uma categoria primeiro."); event.target.value = null; return; } }

                    importedData.forEach(item => {
                        if (!item || typeof item.nome !== 'string' || item.nome.trim() === '') { console.warn("Item inválido ou sem nome no JSON, ignorando:", item); return; }
                        const nomeImportado = item.nome.trim(); const nomeNormalizadoImportado = normalizarTexto(nomeImportado);
                        const itemJaExiste = Object.values(dadosLista).some(itemExistente => normalizarTexto(itemExistente.nome) === nomeNormalizadoImportado);
                        if (itemJaExiste) { console.log(`Item "${nomeImportado}" já existe, ignorando.`); itensIgnorados++; return; }

                        let targetCategoryId = defaultCategoryId; if (item.categoriaId && categoriasDefinidas.some(c => c.id === item.categoriaId)) targetCategoryId = item.categoriaId;
                        const novoItemData = { id: gerarIdUnico(), nome: nomeImportado, checked: item.checked === true, alreadyHave: item.alreadyHave === true, qtd: String(item.qtd || '1.0'), preco: String(item.preco || ''), categoriaId: targetCategoryId, subcategoriaId: `${targetCategoryId}-geral` };
                        dadosLista[novoItemData.id] = novoItemData; adicionarItemNaCategoria(novoItemData, targetCategoryId); itensImportados++;
                    });

                    if (itensImportados > 0) {
                        popularSelectCategorias();
                        _updateAllItemCategorySelects();
                        categoriasContainer.querySelectorAll('.categoria').forEach(calcularInfoCategoria);
                        categoriasContainer.querySelectorAll('.categoria').forEach(updateCategoryToggleButtonState);
                        calcularTotalGeral(); // Recalculate total after import
                        aplicarFiltrosVisibilidadeItens(); // Apply filters
                        salvarDadosAtivos();
                     }
                    alert(`${itensImportados} itens importados com sucesso.\n${itensIgnorados} itens duplicados (nome exato) foram ignorados.`);
                };
                reader.onerror = (e) => { console.error("Erro ao ler arquivo:", e); alert("Erro ao ler o arquivo."); };
                reader.readAsText(file);
                event.target.value = null; // Reset file input
            };

             // --- Popula Lista Inicial ---
             const popularListaInicial = () => { dadosLista = {}; const itensIniciais = [ { nome: 'Banana Prata (kg)', preco: '9.90', cid: 'feira-semanal' }, { nome: 'Laranja Pera (kg)', preco: '5.90', cid: 'feira-semanal' }, { nome: 'Maçã Gala (kg)', preco: '12.50', cid: 'feira-semanal' }, { nome: 'Mamão Formosa (un)', preco: '8.00', cid: 'feira-semanal' }, { nome: 'Alface Crespa (un)', preco: '3.50', cid: 'feira-semanal' }, { nome: 'Tomate Italiano (kg)', preco: '10.80', cid: 'feira-semanal' }, { nome: 'Cebola (kg)', preco: '7.00', cid: 'feira-semanal' }, { nome: 'Batata Inglesa (kg)', preco: '6.00', cid: 'feira-semanal' }, { nome: 'Alho (a granel kg)', preco: '29.90', cid: 'feira-semanal', qtd: '0.2' }, { nome: 'Arroz Agulhinha 5kg', preco: '24.99', cid: 'feira-mensal' }, { nome: 'Feijão Carioca 1kg', preco: '8.99', cid: 'feira-mensal' }, { nome: 'Óleo de Soja 900ml', preco: '5.99', cid: 'feira-mensal' }, { nome: 'Sal Refinado 1kg', preco: '1.99', cid: 'feira-mensal' }, { nome: 'Açúcar Cristal 1kg', preco: '4.49', cid: 'feira-mensal' }, { nome: 'Café Melitta 500g', preco: '16.90', cid: 'feira-mensal' }, { nome: 'Leite Longa Vida (L)', preco: '4.80', cid: 'feira-mensal', qtd: '6.0' }, { nome: 'Macarrão Espaguete 500g', preco: '3.80', cid: 'feira-mensal' }, { nome: 'Sabão em Pó Omo 1.6kg', preco: '25.50', cid: 'limpeza'}, { nome: 'Detergente Ypê Clear 500ml', preco: '2.20', cid: 'limpeza'}, { nome: 'Água Sanitária Qboa 1L', preco: '3.50', cid: 'limpeza'}, { nome: 'Desinfetante Pinho Sol 500ml', preco: '7.80', cid: 'limpeza'}, { nome: 'Esponja Multiuso (pacote)', preco: '4.00', cid: 'limpeza'}, { nome: 'Shampoo Pantene 400ml', preco: '18.90', cid: 'higiene'}, { nome: 'Condicionador Pantene 170ml', preco: '12.90', cid: 'higiene'}, { nome: 'Sabonete Dove Original', preco: '3.50', cid: 'higiene', qtd: '4.0'}, { nome: 'Pasta de Dente Colgate Total 12 90g', preco: '6.50', cid: 'higiene'}, { nome: 'Papel Higiênico Neve (4 rolos)', preco: '8.90', cid: 'higiene'}, { nome: 'Azeite Extra Virgem Gallo 500ml', preco: '32.00', cid: 'condimentos'}, { nome: 'Vinagre de Álcool 750ml', preco: '2.50', cid: 'condimentos'}, { nome: 'Molho de Tomate Heinz Tradicional 300g', preco: '3.20', cid: 'condimentos'}, { nome: 'Maionese Hellmanns 500g', preco: '10.50', cid: 'condimentos'}, { nome: 'Papel Toalha Kitchen (2 rolos)', preco: '6.00', cid: 'outros'}, { nome: 'Filtro de Café Melitta 103 (30 un)', preco: '5.50', cid: 'outros'}, { nome: 'Pano de Chão (un)', preco: '4.00', cid: 'outros'}, ]; itensIniciais.forEach(i => { const d = { id: gerarIdUnico(), nome: i.nome, checked: false, alreadyHave: false, qtd: i.qtd || '1.0', preco: i.preco || '' }; adicionarItemNaCategoria(d, i.cid, `${i.cid}-geral`); }); };

             // Executa a inicialização
             inicializarApp();

         }); // Fim do DOMContentLoaded
     </script>

 </body>
 </html>